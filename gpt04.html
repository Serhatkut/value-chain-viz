<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DHL eCommerce · Customer Journey Map</title>

  <style>
    :root{
      --dhl-red:#D40511;
      --dhl-yellow:#FFCC00;

      --ink:#101828;
      --muted:#667085;
      --bg:#F5F7FA;
      --panel:#FFFFFF;
      --line:rgba(16,24,40,0.12);

      --header-h:56px;
      --deck-collapsed-h:48px;
      --deck-expanded-h:min(42vh, 520px);

      --lane-label-w:280px;

      --tile-h:44px;
      --tile-min-w:220px;

      --shadow: 0 10px 26px rgba(16,24,40,0.10);
      --shadow-2: 0 18px 44px rgba(16,24,40,0.14);

      --radius:14px;

      --belt-h: 68px;

      /* ZERO-SCROLL initial view */
      --gridLaneRows: 2;
      --gridLaneRowH: 50px;
      --gridLaneH: calc(var(--gridLaneRows) * var(--gridLaneRowH) + 18px);

      --tooltipW: 420px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      color:var(--ink);
      background:var(--bg);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }

    .topbar{
      height:var(--header-h);
      background:var(--dhl-red);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      gap:12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.18);
      z-index:50;
      flex:0 0 auto;
    }
    .topbar .title{
      font-weight:900;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:850;
      white-space:nowrap;
    }

    .right{ display:flex; align-items:center; gap:10px; min-width:0; }

    .search{ position:relative; width: 420px; max-width: 42vw; min-width: 260px; }
    .search input{
      width:100%;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.25);
      outline:none;
      padding:0 12px;
      font-size:12px;
      font-weight:750;
      background: rgba(255,255,255,0.12);
      color:#fff;
    }
    .search input::placeholder{ color: rgba(255,255,255,0.78); font-weight:700; }
    .search input:focus{
      box-shadow:0 0 0 3px rgba(255,204,0,0.35);
      border-color: rgba(255,204,0,0.8);
    }

    .split{ position:relative; flex:1 1 auto; min-height:0; }

    .mapWrap{
      position:absolute;
      inset:0 0 var(--deck-collapsed-h) 0;
      display:flex;
      flex-direction:column;
      min-height:0;
      transition: inset 240ms ease;
    }
    .mapWrap.deckOpen{ inset:0 0 var(--deck-expanded-h) 0; }

    .mapHeader{
      background:var(--panel);
      border-bottom:1px solid var(--line);
      box-shadow: 0 4px 14px rgba(16,24,40,0.06);
      z-index:20;
      flex:0 0 auto;
    }

    .stageGrid{
      display:grid;
      grid-template-columns: var(--lane-label-w) repeat(7, minmax(170px, 1fr));
      align-items:stretch;
      gap:0;
    }

    .stageCorner{
      padding:10px 12px;
      border-right:1px solid var(--line);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .stageCorner .hint{
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      line-height:1.2;
    }

    .ownerLegend{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
      max-width: 520px;
    }
    .ownerChip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      height:22px;
      padding:0 8px;
      border-radius:999px;
      border:1px solid rgba(16,24,40,0.12);
      background:#fff;
      font-size:10px;
      font-weight:950;
      color:var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--dot,#999);
      border:1px solid rgba(0,0,0,0.12);
    }

    .stageCell{
      padding:10px 10px 12px 10px;
      border-right:1px solid var(--line);
    }
    .stageCell:last-child{ border-right:none; }

    .stageNo{ font-size:11px; font-weight:950; color:var(--dhl-red); margin-bottom:4px; }
    .stageName{ font-size:13px; font-weight:950; line-height:1.15; margin-bottom:6px; }
    .stageVoice{ font-size:11px; font-weight:850; color:var(--muted); }

    .mapBody{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding:8px 0;
    }

    .laneRow{
      display:grid;
      grid-template-columns: var(--lane-label-w) 1fr;
      gap:0;
      align-items:stretch;
      border-bottom:1px solid rgba(16,24,40,0.08);
      background: rgba(255,255,255,0.35);
    }

    .laneLabel{
      position:sticky;
      left:0;
      z-index:10;
      background: linear-gradient(180deg, #fff 0%, #F6F8FC 100%);
      border-right:1px solid var(--line);
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .laneLabelTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .laneTitle{
      font-size:13px;
      font-weight:950;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .laneCode{
      font-size:11px;
      font-weight:950;
      color:var(--dhl-red);
      background: rgba(212,5,17,0.08);
      border:1px solid rgba(212,5,17,0.18);
      border-radius:999px;
      padding:3px 8px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .laneSub{ font-size:11px; font-weight:800; color:var(--muted); line-height:1.25; }

    .laneControls{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .btn{
      height:28px;
      border-radius:10px;
      padding:0 10px;
      border:1px solid rgba(16,24,40,0.14);
      background:#fff;
      color:#1f2937;
      font-size:11px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:hover{ background:#FFF9E6; border-color: rgba(255,204,0,0.6); }
    .btn:active{ transform: translateY(1px); }

    .laneGrid{
      display:grid;
      grid-template-columns: repeat(7, minmax(170px, 1fr));
      gap:10px;
      padding:10px 10px 12px 10px;
      align-content:start;
    }

    /* Story lanes fixed height */
    .gridLaneFixed{
      height: var(--gridLaneH);
      overflow:hidden;
      border-radius:14px;
      grid-column: 1 / -1;
      display:grid;
      grid-template-columns: repeat(7, minmax(170px, 1fr));
      gap:10px;
      padding:2px 0 0 0;
    }

    .stageCol{
      position:relative;
      height: calc(var(--gridLaneRows) * var(--gridLaneRowH));
      padding:2px 0 2px 0;
      display:grid;
      grid-template-rows: repeat(var(--gridLaneRows), var(--gridLaneRowH));
      gap:6px;
      align-content:start;
    }

    .moreChip{
      position:absolute;
      right:0;
      bottom:-2px;
      transform: translateY(100%);
      height:28px;
      padding:0 10px;
      border-radius:999px;
      background:#fff;
      border:1px dashed rgba(16,24,40,0.22);
      font-size:11px;
      font-weight:950;
      color:var(--muted);
      cursor:pointer;
      display:none;
      align-items:center;
      gap:6px;
      box-shadow: 0 8px 16px rgba(16,24,40,0.08);
      white-space:nowrap;
      user-select:none;
    }
    .moreChip.show{ display:inline-flex; }
    .moreChip:hover{ background:#FFF9E6; border-color: rgba(255,204,0,0.7); color:#7a5a00; }

    .continuousRow{
      grid-column:1/-1;
      display:flex;
      gap:10px;
      align-items:center;
      height: 42px;
      padding:0 6px;
      margin-top:6px;
    }
    .continuousLabel{
      font-size:11px;
      font-weight:950;
      color:var(--muted);
      white-space:nowrap;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(16,24,40,0.12);
      background:#fff;
    }
    .continuousRow .tile{ height:42px; }

    /* BELT lanes */
    .beltWrap{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      gap:10px;
      height: var(--belt-h);
      padding:10px;
      border:1px solid rgba(16,24,40,0.10);
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.90) 0%, rgba(247,248,251,0.85) 100%);
      overflow:hidden;
    }
    .belt{
      display:flex;
      gap:10px;
      align-items:center;
      overflow:hidden; /* Start/End enables scroll */
      padding-bottom:2px;
      flex: 1 1 auto;
      min-width:0;
    }
    .beltHint{
      flex:0 0 auto;
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(16,24,40,0.12);
      background:#fff;
    }

    /* FOUNDATION: collapsed summary row (default) */
    .foundationBar{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      gap:10px;
      height: 52px;
      padding:10px;
      border:1px solid rgba(16,24,40,0.10);
      border-radius:14px;
      background:#fff;
      overflow:hidden;
    }
    .foundationChip{
      flex:0 0 auto;
      height:32px;
      padding:0 10px;
      border-radius:999px;
      border:1px solid rgba(16,24,40,0.12);
      background:#F7F8FB;
      font-size:11px;
      font-weight:950;
      color:#1f2937;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .foundationChip:hover{
      background:#FFF9E6;
      border-color: rgba(255,204,0,0.55);
    }
    .foundationChip .cnt{
      font-size:10px;
      font-weight:950;
      color:var(--muted);
      border:1px solid rgba(16,24,40,0.12);
      background:#fff;
      padding:2px 7px;
      border-radius:999px;
    }

    /* TILE: owner colored band */
    .tile{
      height: var(--tile-h);
      min-width: var(--tile-min-w);
      width: 100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 14px 8px 14px;
      cursor:pointer;
      user-select:none;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,232,154,0.95) 0%, rgba(255,204,0,0.95) 88%);
      color:#1a1a1a;
      border:1px solid rgba(16,24,40,0.14);
      box-shadow: 0 8px 14px rgba(16,24,40,0.09);
      clip-path: polygon(
        0% 0%,
        calc(100% - 18px) 0%,
        100% 50%,
        calc(100% - 18px) 100%,
        0% 100%,
        18px 50%
      );
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      overflow:hidden;
      position:relative;
    }
    .tile::before{
      content:"";
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:10px;
      background: var(--own,#9aa4b2);
      opacity:0.92;
      border-right:1px solid rgba(0,0,0,0.10);
    }

    .tile:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(16,24,40,0.12);
      filter: brightness(0.99);
    }
    .tile.active{
      background: var(--dhl-red);
      color:#fff;
      border-color: rgba(0,0,0,0.18);
      box-shadow: 0 0 0 3px rgba(255,204,0,0.65), 0 14px 26px rgba(16,24,40,0.14);
    }
    .tile.active::before{ opacity:1; }

    .tileId{
      flex:0 0 auto;
      font-size:11px;
      font-weight:950;
      color: var(--dhl-red);
      background: rgba(255,255,255,0.70);
      border:1px solid rgba(212,5,17,0.20);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
      max-width: 52%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tileName{
      font-size:12px;
      font-weight:900;
      line-height:1.1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
      flex: 1 1 auto;
      padding-left:4px;
    }
    .tileStageChip{
      flex: 0 0 auto;
      font-size:10px;
      font-weight:950;
      color: #1f2937;
      background: rgba(255,255,255,0.78);
      border: 1px solid rgba(16,24,40,0.16);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* Collapsed lane */
    .laneRow.collapsed .laneGrid{ display:none !important; }
    .collapsedNote{
      padding:10px 10px 12px 10px;
      color:var(--muted);
      font-weight:850;
      font-size:12px;
    }

    /* Drawer */
    .drawerBackdrop{
      position:fixed;
      inset:0;
      background: rgba(16,24,40,0.42);
      display:none;
      z-index:999;
    }
    .drawerBackdrop.show{ display:block; }

    .drawer{
      position:fixed;
      top: calc(var(--header-h) + 12px);
      right: 12px;
      width: min(520px, 92vw);
      height: min(70vh, 740px);
      background:#fff;
      border:1px solid rgba(16,24,40,0.14);
      border-radius:16px;
      box-shadow: var(--shadow-2);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      z-index:1000;
    }
    .drawerHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      background:#F7F8FB;
      border-bottom:1px solid var(--line);
    }
    .drawerTitle{ font-size:13px; font-weight:950; margin:0; line-height:1.15; }
    .drawerSub{ font-size:11px; font-weight:850; color:var(--muted); margin-top:4px; }
    .drawerClose{
      height:30px;
      padding:0 10px;
      border-radius:10px;
      border:1px solid rgba(16,24,40,0.14);
      background:#fff;
      font-size:11px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .drawerClose:hover{ background:#FFF9E6; border-color: rgba(255,204,0,0.6); }

    .drawerBody{
      padding:10px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .drawerSection{
      border:1px solid rgba(16,24,40,0.10);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .drawerSectionHead{
      padding:10px 10px;
      background:#fff;
      border-bottom:1px solid rgba(16,24,40,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawerSectionTitle{
      font-size:12px;
      font-weight:950;
      color:var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .drawerSectionCount{
      font-size:11px;
      font-weight:950;
      color:var(--muted);
      border:1px solid rgba(16,24,40,0.12);
      background:#F7F8FB;
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .drawerList{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .drawerList .tile{
      clip-path:none;
      border-radius:12px;
    }

    /* Tooltip */
    .tooltip{
      position:fixed;
      z-index:2000;
      width:min(var(--tooltipW), 92vw);
      background:#fff;
      border:1px solid rgba(16,24,40,0.16);
      border-radius:14px;
      box-shadow: var(--shadow-2);
      padding:10px 10px;
      display:none;
      pointer-events:none;
    }
    .tooltip.show{ display:block; }
    .ttTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .ttTitle{
      font-size:12px;
      font-weight:950;
      line-height:1.2;
      margin:0;
      color:var(--ink);
    }
    .ttOwner{
      font-size:11px;
      font-weight:950;
      border-radius:999px;
      padding:4px 8px;
      color:#fff;
      white-space:nowrap;
    }
    .ttDesc{
      font-size:11px;
      font-weight:800;
      color:var(--muted);
      line-height:1.35;
      margin:0 0 8px 0;
    }
    .ttStats{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .ttPill{
      font-size:10px;
      font-weight:950;
      border-radius:999px;
      padding:4px 8px;
      border:1px solid rgba(16,24,40,0.12);
      background:#F7F8FB;
      color:#1f2937;
      white-space:nowrap;
    }

    .error{
      margin:12px 14px;
      padding:12px 12px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(180,35,24,0.22);
      color:#b42318;
      font-weight:900;
      box-shadow: var(--shadow);
    }

    @media (max-width: 980px){
      :root{ --lane-label-w: 240px; }
      .search{ width: 320px; }
      .ownerLegend{ display:none; }
    }
    @media (max-width: 720px){
      :root{ --lane-label-w: 210px; }
      .pill{ display:none; }
      .search{ width: 240px; min-width: 200px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <span>DHL eCommerce · Customer Journey Map</span>
        <span class="pill">Owner-colored chevrons · Foundation horizontal + collapsed · Hover tooltips</span>
      </div>
      <div class="right">
        <div class="search">
          <input id="searchInput" placeholder="Search ID (Enter)… e.g., O2D_04" autocomplete="off" />
        </div>
      </div>
    </div>

    <div class="split">
      <div id="mapWrap" class="mapWrap">
        <div class="mapHeader">
          <div class="stageGrid" id="stageHeader"></div>
        </div>
        <div class="mapBody" id="mapBody"></div>
        <div id="errBox" class="error" style="display:none;"></div>
      </div>

      <!-- Deck -->
      <div id="deck" style="position:absolute;left:0;right:0;bottom:0;height:48px;background:#fff;border-top:3px solid var(--dhl-yellow);box-shadow:0 -12px 30px rgba(16,24,40,0.12);display:flex;flex-direction:column;min-height:0;transition:height 240ms ease;z-index:40;">
        <div id="deckHandle" style="height:48px;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:0 14px;cursor:pointer;user-select:none;">
          <div style="display:flex;align-items:center;gap:10px;min-width:0;">
            <div style="width:30px;height:30px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:rgba(212,5,17,0.10);border:1px solid rgba(212,5,17,0.18);font-weight:950;color:var(--dhl-red);flex:0 0 auto;">≡</div>
            <div id="deckHandleTitle" style="font-size:12px;font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:62vw;">Select an L1 chevron to view details</div>
          </div>
          <div id="deckHint" style="font-size:11px;font-weight:850;color:var(--muted);white-space:nowrap;flex:0 0 auto;">▲ Expand</div>
        </div>
        <div id="deckBody" style="display:none;border-top:1px solid var(--line);padding:12px 14px 14px 14px;overflow:auto;min-height:0;flex-direction:column;gap:12px;"></div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawerBackdrop" class="drawerBackdrop" aria-hidden="true"></div>
  <div id="drawer" class="drawer" style="display:none;" role="dialog" aria-modal="true" aria-label="Lane Drawer">
    <div class="drawerHead">
      <div>
        <div id="drawerTitle" class="drawerTitle">More items</div>
        <div id="drawerSub" class="drawerSub"></div>
      </div>
      <button id="drawerClose" class="drawerClose">Close</button>
    </div>
    <div id="drawerBody" class="drawerBody"></div>
  </div>

  <!-- Tooltip -->
  <div id="tooltip" class="tooltip" aria-hidden="true"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const STAGES = [
      { no: 1, name: "Awareness & Plan", voice: "I discover" },
      { no: 2, name: "Offer & Account", voice: "I agree" },
      { no: 3, name: "Onboarding", voice: "I integrate" },
      { no: 4, name: "Booking & Collect", voice: "I ship" },
      { no: 5, name: "Export & Transit", voice: "It moves" },
      { no: 6, name: "Import & Last Mile", voice: "I receive" },
      { no: 7, name: "Post-Shipment", voice: "I pay/return" }
    ];

    const LANES = [
      { key: "COMM", label: "Commercial", l0Codes: ["L2C"], sub: "Top Priority", laneCode: "L2C", renderMode:"gridStory", defaultCollapsed:false },
      { key: "OPS",  label: "Operations", l0Codes: ["O2D"], sub: "Core Logistics", laneCode: "O2D", renderMode:"gridStory", defaultCollapsed:false },
      { key: "DES",  label: "Design", l0Codes: ["D2O"], sub: "Network & Product Design", laneCode: "D2O", renderMode:"gridStory", defaultCollapsed:false },

      { key: "RESO", label: "Resolution", l0Codes: ["P2R"], sub: "Issue Management", laneCode: "P2R", renderMode:"belt", defaultCollapsed:false },
      { key: "RSRC", label: "Resources", l0Codes: ["S2P","H2R"], sub: "Sourcing & HR", laneCode: "S2P & H2R", renderMode:"belt", defaultCollapsed:false },

      // Foundation: horizontal chips, collapsed look; clicking chips opens drawer
      { key: "FND",  label: "Foundation", l0Codes: ["S2E","GRC","ITF","EA_PM","DA","I2P","TRF","R2R"], sub: "Strategy & Enablers", laneCode: "S2E, GRC, IT, EA, DA", renderMode:"foundationCollapsed", defaultCollapsed:false },
    ];

    const STORY_MAX_PER_STAGE = 2;
    const BELT_VISIBLE = 4;

    const SPAN_RULES = [
      { match: { l0: "L2C", l1: "L2C_08" }, span: { from: 4, to: 7 } },
      { match: { l0: "P2R" }, span: { from: 4, to: 7 } }
    ];

    /***********************
     * Utilities
     ***********************/
    const $ = (sel) => document.querySelector(sel);
    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

    function parseInfo(name){
      if(!name) return { id:"", name:"" };
      const parts = String(name).split(":");
      const id = parts[0].trim();
      const nm = parts.slice(1).join(":").trim() || id;
      return { id, name: nm };
    }
    function safeChildren(n){ return (n && Array.isArray(n.children)) ? n.children : []; }

    function getL0Map(root){
      const m = new Map();
      safeChildren(root).forEach(l0=>{
        const inf = parseInfo(l0.name);
        if(inf.id) m.set(inf.id, l0);
      });
      return m;
    }
    function extractTrailingNumber(id){
      const m = String(id || "").match(/_(\d+)\s*$/);
      return m ? Number(m[1]) : null;
    }
    function getSpanFor(l0Id, l1Id){
      for(const r of SPAN_RULES){
        const m = r.match || {};
        const okL0 = (m.l0 == null) || (m.l0 === l0Id);
        const okL1 = (m.l1 == null) || (m.l1 === l1Id);
        if(okL0 && okL1) return r.span;
      }
      return null;
    }

    /***********************
     * Primary ownership -> stable color
     ***********************/
    const OWNER_COLOR_CACHE = new Map();
    function normalizeOwner(owner){
      const o = String(owner || "").trim();
      if(!o) return "Unassigned";
      return o.split("|")[0].split("/")[0].split(",")[0].trim() || "Unassigned";
    }
    function hashString(str){
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return (h >>> 0);
    }
    function ownerToColor(owner){
      const key = normalizeOwner(owner);
      if(OWNER_COLOR_CACHE.has(key)) return OWNER_COLOR_CACHE.get(key);
      const hue = hashString(key) % 360;
      const col = `hsl(${hue} 62% 45%)`;
      OWNER_COLOR_CACHE.set(key, col);
      return col;
    }

    /***********************
     * Stage mapping heuristics
     ***********************/
    function colForL1(l0Id, l1Node){
      const { id: l1Id, name: l1Name } = parseInfo(l1Node.name);
      const n = extractTrailingNumber(l1Id);

      if(l0Id === "L2C"){
        if(n === 1) return 1;
        if(n === 2) return 2;
        if(n === 3) return 2;
        if(n === 4) return 3;
        if(n === 5) return 4;
        if(n === 6) return 7;
        if(n === 7) return 7;
        if(n === 8) return 6;
        return 3;
      }

      if(l0Id === "O2D"){
        if(n === 1) return 4;
        if(n === 2) return 4;
        if(n === 3) return 4;
        if(n === 4) return 5;
        if(n === 5) return 5;
        if(n === 6) return 5;
        if(n === 7) return 6;
        if(n === 8) return 6;
        if(n === 9) return 6;
        if(n === 10) return 6;
        if(n === 11) return 6;
        if(n === 12) return 7;
        return 5;
      }

      if(l0Id === "D2O"){
        if(n === 1) return 2;
        if(n === 2) return 2;
        if(n === 3) return 3;
        if(n === 4) return 4;
        if(n === 5) return 4;
        if(n === 6) return 5;
        if(n === 7) return 6;
        if(n === 8) return 7;
        return 3;
      }

      const nm = (l1Name || "").toLowerCase();
      if(nm.includes("strategy") || nm.includes("governance")) return 1;
      if(nm.includes("architecture") || nm.includes("portfolio")) return 2;
      if(nm.includes("platform") || nm.includes("integration") || nm.includes("data")) return 3;
      if(nm.includes("security") || nm.includes("risk") || nm.includes("compliance")) return 1;
      return 2;
    }
    function stageChipText(l0Id, l1Id, l1Node){
      const span = getSpanFor(l0Id, l1Id);
      if(span) return `S${span.from}–S${span.to}`;
      const c = colForL1(l0Id, l1Node);
      return `S${c}`;
    }

    /***********************
     * Tooltip
     ***********************/
    const tooltip = $("#tooltip");
    let ttTimer = null;

    function truncate(s, n=220){
      const t = String(s||"").trim();
      if(!t) return "";
      return t.length > n ? t.slice(0,n-1) + "…" : t;
    }
    function countL2L3(l1Node){
      const l2s = safeChildren(l1Node);
      let l3Count = 0;
      for(const l2 of l2s) l3Count += safeChildren(l2).length;
      return { l2: l2s.length, l3: l3Count };
    }
    function showTooltipNear(x,y, html){
      tooltip.innerHTML = html;
      tooltip.classList.add("show");
      tooltip.setAttribute("aria-hidden","false");

      const pad = 14;
      const rect = tooltip.getBoundingClientRect();
      let left = x + 14;
      let top = y + 14;

      if(left + rect.width + pad > window.innerWidth) left = x - rect.width - 14;
      if(top + rect.height + pad > window.innerHeight) top = y - rect.height - 14;

      tooltip.style.left = Math.max(pad, left) + "px";
      tooltip.style.top = Math.max(pad, top) + "px";
    }
    function hideTooltip(){
      tooltip.classList.remove("show");
      tooltip.setAttribute("aria-hidden","true");
    }

    /***********************
     * State
     ***********************/
    let ROOT = null;
    let L0MAP = null;
    const laneCollapsed = {};
    const OWNER_COUNTS = new Map();

    /***********************
     * Render header
     ***********************/
    function renderStageHeader(){
      const wrap = $("#stageHeader");
      wrap.innerHTML = "";

      const corner = document.createElement("div");
      corner.className = "stageCorner";
      corner.innerHTML = `
        <div class="hint">
          <div style="font-weight:950;color:var(--ink);">Swimlanes</div>
          <div>Hover for quick details · Click for deck</div>
        </div>
        <div class="ownerLegend" id="ownerLegend"></div>
      `;
      wrap.appendChild(corner);

      STAGES.forEach(s=>{
        const cell = document.createElement("div");
        cell.className = "stageCell";
        cell.innerHTML = `
          <div class="stageNo">Step ${esc(s.no)}</div>
          <div class="stageName">${esc(s.name)}</div>
          <div class="stageVoice">${esc(s.voice)}</div>
        `;
        wrap.appendChild(cell);
      });
    }

    function renderOwnerLegend(){
      const el = document.getElementById("ownerLegend");
      if(!el) return;
      el.innerHTML = "";

      const entries = Array.from(OWNER_COUNTS.entries())
        .sort((a,b)=>b[1]-a[1])
        .slice(0,8);

      for(const [owner, cnt] of entries){
        const chip = document.createElement("div");
        chip.className = "ownerChip";
        const color = ownerToColor(owner);
        chip.innerHTML = `<span class="dot" style="--dot:${esc(color)}"></span>${esc(owner)} <span style="opacity:.75;">(${cnt})</span>`;
        el.appendChild(chip);
      }
    }

    /***********************
     * Drawer
     ***********************/
    const drawer = $("#drawer");
    const drawerBackdrop = $("#drawerBackdrop");
    const drawerTitle = $("#drawerTitle");
    const drawerSub = $("#drawerSub");
    const drawerBody = $("#drawerBody");
    const drawerClose = $("#drawerClose");

    function openDrawer(ctx){
      drawerTitle.textContent = ctx.title || "More items";
      drawerSub.textContent = ctx.subtitle || "";
      drawerBody.innerHTML = "";

      (ctx.sections || []).forEach(sec => {
        const section = document.createElement("div");
        section.className = "drawerSection";
        section.innerHTML = `
          <div class="drawerSectionHead">
            <div class="drawerSectionTitle">${esc(sec.title || "")}</div>
            <div class="drawerSectionCount">${esc(sec.countText || "")}</div>
          </div>
          <div class="drawerList"></div>
        `;
        const list = section.querySelector(".drawerList");
        (sec.items || []).forEach(it => list.appendChild(buildTile(it, { showStageChip:true, simpleShape:true })));
        drawerBody.appendChild(section);
      });

      drawer.style.display = "flex";
      drawerBackdrop.classList.add("show");
      drawerBackdrop.setAttribute("aria-hidden","false");
    }
    function closeDrawer(){
      drawer.style.display = "none";
      drawerBackdrop.classList.remove("show");
      drawerBackdrop.setAttribute("aria-hidden","true");
    }
    drawerClose.addEventListener("click", closeDrawer);
    drawerBackdrop.addEventListener("click", closeDrawer);
    document.addEventListener("keydown", (e) => { if(e.key === "Escape") closeDrawer(); });

    /***********************
     * Deck
     ***********************/
    const deck = $("#deck");
    const deckHandle = $("#deckHandle");
    const deckHandleTitle = $("#deckHandleTitle");
    const deckHint = $("#deckHint");
    const deckBody = $("#deckBody");
    const mapWrap = $("#mapWrap");

    function setDeckOpen(open){
      if(open){
        deck.classList.add("open");
        deck.style.height = getComputedStyle(document.documentElement).getPropertyValue("--deck-expanded-h");
        mapWrap.classList.add("deckOpen");
        deckBody.style.display = "flex";
        deckHint.textContent = "▼ Collapse";
      } else {
        deck.classList.remove("open");
        deck.style.height = getComputedStyle(document.documentElement).getPropertyValue("--deck-collapsed-h");
        mapWrap.classList.remove("deckOpen");
        deckBody.style.display = "none";
        deckHint.textContent = "▲ Expand";
      }
    }
    deckHandle.addEventListener("click", () => setDeckOpen(!deck.classList.contains("open")));

    function highlightActiveTile(l0Id, l1Id){
      document.querySelectorAll(".tile").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(`.tile[data-l0="${CSS.escape(l0Id)}"][data-l1="${CSS.escape(l1Id)}"]`).forEach(t => t.classList.add("active"));
    }

    function selectL1(l0Id, l1Node){
      const l0Node = L0MAP.get(l0Id);
      const l0Info = parseInfo(l0Node?.name);
      const l1Info = parseInfo(l1Node?.name);

      deckHandleTitle.textContent = `${l1Info.id} — ${l1Info.name}`;

      const owner = (l1Node?.owner || l0Node?.owner || "Unassigned");
      const desc = (l1Node?.description || "");

      const l2s = safeChildren(l1Node).map(l2=>{
        const i2 = parseInfo(l2.name);
        const l3s = safeChildren(l2).map(l3=>{
          const i3 = parseInfo(l3.name);
          return { id: i3.id, name: i3.name, node: l3 };
        });
        return { id: i2.id, name: i2.name, node: l2, l3s };
      });

      deckBody.innerHTML = `
        <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-start;justify-content:space-between;">
          <div style="min-width:280px;flex:1 1 380px;">
            <p style="font-size:16px;font-weight:980;margin:0 0 4px 0;line-height:1.15;">${esc(l1Info.id)} · ${esc(l1Info.name)}</p>
            <p style="margin:0;font-size:12px;color:var(--muted);font-weight:750;line-height:1.4;max-width:1100px;">${esc(desc || "No description available.")}</p>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center;flex:0 0 auto;">
            <span style="font-size:11px;font-weight:900;border-radius:999px;padding:6px 10px;border:1px solid rgba(16,24,40,0.14);background:rgba(212,5,17,0.08);border-color:rgba(212,5,17,0.18);color:var(--dhl-red);white-space:nowrap;">${esc(l0Info.id || l0Id)} · L0</span>
            <span style="font-size:11px;font-weight:900;border-radius:999px;padding:6px 10px;border:1px solid rgba(0,0,0,0.16);background:#111827;color:#fff;white-space:nowrap;">Owner: ${esc(owner)}</span>
          </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-size:12px;font-weight:950;color:var(--ink);">L2 Sub-processes → L3 Activities</div>
          <div style="font-size:11px;font-weight:850;color:var(--muted);white-space:nowrap;">L3 is always visible</div>
        </div>

        <div id="l2Chain" style="display:flex;gap:10px;overflow:auto;padding-bottom:4px;scroll-snap-type:x mandatory;"></div>
      `;

      const chain = document.getElementById("l2Chain");
      if(!l2s.length){
        chain.innerHTML = `<div style="padding:14px 12px;color:var(--muted);font-weight:800;font-size:12px;">No L2 sub-processes found for this L1.</div>`;
      } else {
        for(const l2 of l2s){
          const block = document.createElement("div");
          block.style.cssText = `
            flex:0 0 min(380px, 92vw);
            background:#fff;
            border:1px solid rgba(16,24,40,0.12);
            border-radius:14px;
            box-shadow: 0 10px 20px rgba(16,24,40,0.06);
            padding:10px 10px 8px 10px;
            scroll-snap-align:start;
            min-height: 120px;
            display:flex;
            flex-direction:column;
            gap:8px;
          `;

          const l2Owner = (l2.node?.owner || l1Node?.owner || l0Node?.owner || "Unassigned");

          const l3Html = (l2.l3s.length)
            ? l2.l3s.map(x => `
                <div style="border-left: 3px solid rgba(16,24,40,0.18);background:#FBFCFE;border-radius:10px;padding:8px 10px;border-top:1px solid rgba(16,24,40,0.06);border-right:1px solid rgba(16,24,40,0.06);border-bottom:1px solid rgba(16,24,40,0.06);">
                  <div style="font-size:10px;font-weight:950;color:var(--muted);text-transform:uppercase;letter-spacing:0.3px;margin-bottom:3px;display:flex;justify-content:space-between;gap:10px;">
                    <span>${esc(x.id)}</span>
                    <span>${esc(l2Owner)}</span>
                  </div>
                  <p style="font-size:12px;font-weight:850;margin:0;line-height:1.25;color:#111827;">${esc(x.name)}</p>
                </div>
              `).join("")
            : `<div style="padding:14px 12px;color:var(--muted);font-weight:800;font-size:12px;">No L3 activities.</div>`;

          block.innerHTML = `
            <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding-bottom:8px;border-bottom:1px solid rgba(16,24,40,0.08);">
              <div style="min-width:0;">
                <div style="font-size:11px;font-weight:950;color:var(--dhl-red);margin-bottom:4px;">${esc(l2.id)}</div>
                <p style="font-size:13px;font-weight:950;line-height:1.15;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:320px;" title="${esc(l2.name)}">${esc(l2.name)}</p>
              </div>
              <div style="text-align:right;">
                <div style="font-size:10px;font-weight:950;border-radius:999px;padding:5px 8px;border:1px solid rgba(255,204,0,0.55);background:#FFF9E6;color:#7a5a00;white-space:nowrap;">
                  L2 Owner: ${esc(l2Owner)}
                </div>
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;padding-top:2px;">${l3Html}</div>
          `;
          chain.appendChild(block);
        }
      }

      setDeckOpen(true);
    }

    /***********************
     * Tile builder (hover tooltip + owner band)
     ***********************/
    function buildTile(item, { showStageChip=false, simpleShape=false }){
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.dataset.l0 = item.l0Id;
      tile.dataset.l1 = item.l1Id;

      if(simpleShape){
        tile.style.clipPath = "none";
        tile.style.borderRadius = "12px";
      }

      const owner = normalizeOwner(item.owner || item.l0Owner || "Unassigned");
      const ownColor = ownerToColor(owner);
      tile.style.setProperty("--own", ownColor);

      const chip = stageChipText(item.l0Id, item.l1Id, item.l1Node);

      tile.innerHTML = `
        <span class="tileId">${esc(item.l1Id)}</span>
        <span class="tileName" title="${esc(item.l1Name)}">${esc(item.l1Name)}</span>
        ${showStageChip ? `<span class="tileStageChip">${esc(chip)}</span>` : ``}
      `;

      // Click -> deck
      tile.addEventListener("click", () => {
        selectL1(item.l0Id, item.l1Node);
        highlightActiveTile(item.l0Id, item.l1Id);
        closeDrawer();
        hideTooltip();
      });

      // Hover -> tooltip
      tile.addEventListener("mouseenter", (e) => {
        if(ttTimer) clearTimeout(ttTimer);
        const { l2, l3 } = countL2L3(item.l1Node);
        const desc = truncate(item.l1Node?.description || "");
        const l0 = item.l0Id;
        const l1 = item.l1Id;

        ttTimer = setTimeout(() => {
          const html = `
            <div class="ttTop">
              <p class="ttTitle">${esc(l1)} · ${esc(item.l1Name)}</p>
              <span class="ttOwner" style="background:${esc(ownColor)}">${esc(owner)}</span>
            </div>
            <p class="ttDesc">${esc(desc || "No description available.")}</p>
            <div class="ttStats">
              <span class="ttPill">L0: ${esc(l0)}</span>
              <span class="ttPill">L2: ${esc(l2)}</span>
              <span class="ttPill">L3: ${esc(l3)}</span>
              <span class="ttPill">Stage: ${esc(chip)}</span>
            </div>
          `;
          showTooltipNear(e.clientX, e.clientY, html);
        }, 180);
      });

      tile.addEventListener("mousemove", (e) => {
        if(!tooltip.classList.contains("show")) return;
        showTooltipNear(e.clientX, e.clientY, tooltip.innerHTML);
      });

      tile.addEventListener("mouseleave", () => {
        if(ttTimer) clearTimeout(ttTimer);
        hideTooltip();
      });

      return tile;
    }

    /***********************
     * Render map
     ***********************/
    function renderMap(){
      const body = $("#mapBody");
      body.innerHTML = "";
      OWNER_COUNTS.clear();

      for(const lane of LANES){
        if(laneCollapsed[lane.key] == null) laneCollapsed[lane.key] = !!lane.defaultCollapsed;

        const row = document.createElement("div");
        row.className = "laneRow";
        row.dataset.laneKey = lane.key;
        if(laneCollapsed[lane.key]) row.classList.add("collapsed");

        const label = document.createElement("div");
        label.className = "laneLabel";

        const isBelt = lane.renderMode === "belt";

        label.innerHTML = `
          <div class="laneLabelTop">
            <div class="laneTitle">${esc(lane.label)}</div>
            <span class="laneCode">${esc(lane.laneCode)}</span>
          </div>
          <div class="laneSub">${esc(lane.sub || "")}</div>
          <div class="laneControls">
            <button class="btn" data-action="toggle" data-lane="${esc(lane.key)}">
              ${laneCollapsed[lane.key] ? "Expand" : "Collapse"}
            </button>
            ${isBelt ? `
              <button class="btn" data-action="home" data-lane="${esc(lane.key)}">⟸ Start</button>
              <button class="btn" data-action="end" data-lane="${esc(lane.key)}">End ⟹</button>
            ` : ""}
          </div>
        `;

        const content = document.createElement("div");
        content.className = "laneGrid";

        // Collect items
        const allItems = [];
        for(const l0Code of lane.l0Codes){
          const l0Node = L0MAP.get(l0Code);
          if(!l0Node) continue;
          const l0Owner = l0Node?.owner || "Unassigned";

          for(const l1 of safeChildren(l0Node)){
            const i1 = parseInfo(l1.name);
            const owner = l1?.owner || l0Owner || "Unassigned";
            const key = normalizeOwner(owner);
            OWNER_COUNTS.set(key, (OWNER_COUNTS.get(key) || 0) + 1);

            allItems.push({
              l0Id: l0Code,
              l0Owner,
              l1Id: i1.id,
              l1Name: i1.name,
              l1Node: l1,
              owner
            });
          }
        }

        if(laneCollapsed[lane.key]){
          const note = document.createElement("div");
          note.className = "collapsedNote";
          note.textContent = allItems.length ? `${allItems.length} L1 processes hidden.` : "No processes found for this lane.";
          content.appendChild(note);
        } else {
          if(!allItems.length){
            content.innerHTML = `<div class="error" style="grid-column:1/-1;">No processes found for this lane in data.json.</div>`;
          } else {
            if(lane.renderMode === "belt"){
              renderBeltLane(content, lane, allItems);
            } else if(lane.renderMode === "foundationCollapsed"){
              renderFoundationCollapsed(content, lane, allItems);
            } else {
              renderGridStoryLane(content, lane, allItems);
            }
          }
        }

        row.appendChild(label);
        row.appendChild(content);
        body.appendChild(row);
      }

      // controls
      body.querySelectorAll(".btn[data-action]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const action = btn.dataset.action;
          const laneKey = btn.dataset.lane;

          if(action === "toggle"){
            laneCollapsed[laneKey] = !laneCollapsed[laneKey];
            renderMap();
            return;
          }

          if(action === "home" || action === "end"){
            const belt = body.querySelector(`.belt[data-belt-lane="${CSS.escape(laneKey)}"]`);
            if(!belt) return;
            belt.style.overflowX = "auto";
            belt.style.scrollBehavior = "smooth";
            if(action === "home") belt.scrollTo({ left: 0, behavior: "smooth" });
            if(action === "end") belt.scrollTo({ left: belt.scrollWidth, behavior: "smooth" });
          }
        });
      });

      renderOwnerLegend();
    }

    function renderBeltLane(content, lane, allItems){
      const visible = allItems.slice(0, BELT_VISIBLE);
      const hidden = allItems.slice(BELT_VISIBLE);

      const beltWrap = document.createElement("div");
      beltWrap.className = "beltWrap";

      const hint = document.createElement("div");
      hint.className = "beltHint";
      hint.textContent = "Compact belt";

      const belt = document.createElement("div");
      belt.className = "belt";
      belt.dataset.beltLane = lane.key;

      visible.forEach(it => belt.appendChild(buildTile(it, { showStageChip:true })));

      if(hidden.length){
        const more = document.createElement("div");
        more.className = "moreChip show";
        more.style.position = "static";
        more.style.transform = "none";
        more.textContent = `+${hidden.length} more`;
        more.addEventListener("click", () => {
          openDrawer({
            title: `${lane.label} · Hidden Processes`,
            subtitle: `Select a process to open details.`,
            sections: [{
              title: "Overflow list",
              countText: `${hidden.length} items`,
              items: hidden
            }]
          });
        });
        belt.appendChild(more);
      }

      beltWrap.appendChild(hint);
      beltWrap.appendChild(belt);
      content.appendChild(beltWrap);
    }

    function renderGridStoryLane(content, lane, allItems){
      const perStage = Array.from({length:7}, () => []);
      const continuous = [];

      for(const it of allItems){
        const span = getSpanFor(it.l0Id, it.l1Id);
        if(span){
          continuous.push({ ...it, span });
          continue;
        }
        const col = colForL1(it.l0Id, it.l1Node);
        const idx = Math.max(1, Math.min(7, col)) - 1;
        perStage[idx].push(it);
      }

      const wrapper = document.createElement("div");
      wrapper.className = "gridLaneFixed";

      perStage.forEach((list, i) => {
        const col = document.createElement("div");
        col.className = "stageCol";

        const shown = list.slice(0, STORY_MAX_PER_STAGE);
        const hidden = list.slice(STORY_MAX_PER_STAGE);

        shown.forEach(it => col.appendChild(buildTile(it, { showStageChip:false })));

        for(let k=shown.length; k<STORY_MAX_PER_STAGE; k++){
          const spacer = document.createElement("div");
          spacer.style.height = "44px";
          spacer.style.borderRadius = "12px";
          spacer.style.border = "1px dashed rgba(16,24,40,0.10)";
          spacer.style.background = "rgba(255,255,255,0.55)";
          col.appendChild(spacer);
        }

        const chip = document.createElement("div");
        chip.className = "moreChip";
        chip.textContent = `+${hidden.length}`;
        if(hidden.length) chip.classList.add("show");
        chip.addEventListener("click", () => {
          openDrawer({
            title: `${lane.label} · Stage ${i+1} Overflow`,
            subtitle: `Stage: ${STAGES[i].name} · Select a process to open details.`,
            sections: [{
              title: `Stage ${i+1} — ${STAGES[i].name}`,
              countText: `${hidden.length} hidden`,
              items: hidden
            }]
          });
        });

        col.appendChild(chip);
        wrapper.appendChild(col);
      });

      content.appendChild(wrapper);

      if(continuous.length){
        const contRow = document.createElement("div");
        contRow.className = "continuousRow";

        const lab = document.createElement("div");
        lab.className = "continuousLabel";
        lab.textContent = "Continuous";
        contRow.appendChild(lab);

        const shownC = continuous.slice(0, 1);
        const hiddenC = continuous.slice(1);

        shownC.forEach(it => contRow.appendChild(buildTile(it, { showStageChip:true })));

        if(hiddenC.length){
          const more = document.createElement("div");
          more.className = "moreChip show";
          more.style.position = "static";
          more.style.transform = "none";
          more.textContent = `+${hiddenC.length} more`;
          more.addEventListener("click", () => {
            openDrawer({
              title: `${lane.label} · Continuous Services`,
              subtitle: `Select a continuous process to open details.`,
              sections: [{
                title: "Continuous overflow",
                countText: `${hiddenC.length} hidden`,
                items: hiddenC
              }]
            });
          });
          contRow.appendChild(more);
        }

        content.appendChild(contRow);
      }
    }

    function renderFoundationCollapsed(content, lane, allItems){
      const groups = new Map();
      for(const it of allItems){
        if(!groups.has(it.l0Id)) groups.set(it.l0Id, []);
        groups.get(it.l0Id).push(it);
      }

      const bar = document.createElement("div");
      bar.className = "foundationBar";

      const hint = document.createElement("div");
      hint.className = "beltHint";
      hint.textContent = "Collapsed groups";
      bar.appendChild(hint);

      for(const code of lane.l0Codes){
        const list = groups.get(code) || [];
        if(!list.length) continue;

        const chip = document.createElement("div");
        chip.className = "foundationChip";
        chip.innerHTML = `${esc(code)} <span class="cnt">${esc(list.length)}</span>`;
        chip.addEventListener("click", () => {
          openDrawer({
            title: `Foundation · ${code}`,
            subtitle: `Select a process to open details.`,
            sections: [{
              title: code,
              countText: `${list.length} items`,
              items: list
            }]
          });
        });
        bar.appendChild(chip);
      }

      content.appendChild(bar);
    }

    /***********************
     * Minimal search (Enter)
     ***********************/
    const searchInput = $("#searchInput");
    searchInput.addEventListener("keydown", (e) => {
      if(e.key !== "Enter") return;
      const q = searchInput.value.trim().toLowerCase();
      if(!q) return;
      const tiles = Array.from(document.querySelectorAll(".tile"));
      const hit = tiles.find(t => (t.dataset.l1 || "").toLowerCase().includes(q));
      if(hit){
        hit.scrollIntoView({ behavior:"smooth", block:"center" });
        hit.click();
      }
    });

    /***********************
     * Init / Load
     ***********************/
    function showError(msg){
      const box = $("#errBox");
      box.style.display = "block";
      box.textContent = msg;
    }

    renderStageHeader();

    fetch("data.json")
      .then(r => {
        if(!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(data => {
        if(!data || !Array.isArray(data.children)){
          showError("data.json loaded but is missing expected 'children' array at root.");
          return;
        }
        ROOT = data;
        L0MAP = getL0Map(ROOT);
        renderMap();
      })
      .catch(err => {
        showError("Cannot load data.json. Run via a local server (not file://) and ensure data.json is next to this HTML. " + err);
        console.error(err);
      });
  </script>
</body>
</html>