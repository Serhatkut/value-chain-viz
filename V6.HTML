<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DHL Strategy House - Master Map</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    /* =========================
       PARAMS (USER-ADJUSTABLE)
       ========================= */
    :root{
      /* L2 sizing (default = S) */
      --l2-scale: 0.60;              /* 0.60 = ~60% width vs old 320px base */
      --l2-base-w: 320px;            /* your original width */
      --l2-w: calc(var(--l2-base-w) * var(--l2-scale));
      --l2-minw: var(--l2-w);

      /* Chevron geometry / overlap */
      --l2-notch: 35px;
      --l2-overlap: -18px;

      /* Equal height for L2 chevrons */
      --l2-fixed-h: 520px;

      /* Shading */
      --l2-bg: #f0f0f0;              /* light gray */
      --l2-bg-hover: #fff4cc;        /* light yellow on hover */

      /* Outline */
      --l2-border: rgba(212,5,17,0.18);
    }

    /* --- LAYOUT RESET --- */
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #f2f4f8;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* --- SCROLLBAR STYLING --- */
    ::-webkit-scrollbar{ width: 14px; height: 14px; }
    ::-webkit-scrollbar-track{ background: #e0e0e0; border-left: 1px solid #ccc; }
    ::-webkit-scrollbar-thumb{ background: #bbb; border-radius: 7px; border: 3px solid #e0e0e0; }
    ::-webkit-scrollbar-thumb:hover{ background: #999; }

    /* --- HEADER --- */
    #app-header{
      background-color: #d40511; color: white; padding: 12px 25px;
      font-size: 20px; font-weight: 800;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      flex-shrink: 0; z-index: 200;
      gap: 14px;
    }
    #header-left{ display:flex; align-items:center; gap: 14px; min-width: 260px; }
    #header-right{ display:flex; align-items:center; gap: 10px; margin-left: auto; }

    .pill{
      font-size: 12px;
      font-weight: 700;
      opacity: 0.9;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(0,0,0,0.12);
      white-space: nowrap;
    }

    /* --- FILTER BAR (replaces search) --- */
    #filter-bar{
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      padding: 10px 25px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .filter-group{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .filter-label{
      font-size: 11px;
      font-weight: 800;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    select.filter{
      height: 34px;
      border-radius: 8px;
      border: 1px solid #d6dbe6;
      background: #fff;
      color: #222;
      padding: 0 10px;
      font-size: 12px;
      font-weight: 600;
      outline: none;
      min-width: 180px;
    }
    select.filter:focus{
      border-color: rgba(212,5,17,0.55);
      box-shadow: 0 0 0 3px rgba(212,5,17,0.12);
    }
    select#filter-size{
      min-width: 110px;
    }
    button#clear-filters{
      height: 34px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #f6f7fb;
      color: #333;
      border-radius: 10px;
      padding: 0 12px;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
    }
    button#clear-filters:hover{
      background: #eceef6;
    }

    /* --- MINI NAV --- */
    #mini-nav{
      background: #333; color: white; padding: 10px 25px; display: none;
      align-items: center; justify-content: space-between; cursor: pointer;
      border-bottom: 3px solid #ffcc00; flex-shrink: 0;
    }
    #mini-nav:hover{ background: #444; }

    /* --- STRATEGY HOUSE (L0) --- */
    #strategy-house-container{
      background: #eef1f5; padding: 25px; transition: all 0.5s ease-in-out;
      max-height: 800px; opacity: 1; overflow: hidden; border-bottom: 1px solid #ccc; flex-shrink: 0;
    }
    #strategy-house-container.collapsed{ max-height: 0; padding: 0 25px; opacity: 0; border-bottom-width: 0; }

    .house-grid{
      display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
      max-width: 1100px; margin: auto; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1));
    }
    .house-section{ padding: 20px; position: relative; display: flex; flex-direction: column; }
    .house-title{ text-align: center; text-transform: uppercase; font-size: 13px; font-weight: 800; letter-spacing: 1px; margin-bottom: 15px; }
    .btn-container{ display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }

    #house-roof{ grid-column: 1 / span 2; background: #d40511; color: white; clip-path: polygon(50% 0%, 100% 25%, 100% 100%, 0% 100%, 0% 25%); padding-top: 40px; margin-bottom: -5px; z-index: 2; }
    #house-pillar-run{ background: #ffcc00; color: #d40511; border: 1px solid rgba(0,0,0,0.05); }
    #house-pillar-transform{ background: #333; color: white; }
    #house-foundation{ grid-column: 1 / span 2; background: #d0d0d0; color: #333; border-radius: 0 0 8px 8px; border-top: 4px solid #bbb; }

    .l0-btn{ border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; text-align: left; min-width: 140px; flex-grow: 1; max-width: 220px; transition: transform 0.2s; position: relative; }
    .l0-btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .l0-btn-id{ font-size: 10px; font-weight: bold; display: block; opacity: 0.8; }
    .l0-btn-name{ font-size: 13px; font-weight: 600; line-height: 1.1; }

    #house-roof .l0-btn{ background: rgba(255,255,255,0.2); color: white; }
    #house-roof .l0-btn:hover{ background: white; color: #d40511; }
    #house-roof .l0-btn.active{ background: white; color: #d40511; box-shadow: 0 0 0 2px #ffcc00; }
    #house-pillar-run .l0-btn{ background: rgba(255,255,255,0.6); color: #000; }
    #house-pillar-run .l0-btn:hover{ background: white; color: #d40511; }
    #house-pillar-run .l0-btn.active{ background: #d40511; color: white; }
    #house-pillar-transform .l0-btn{ background: rgba(255,255,255,0.15); color: #ddd; }
    #house-pillar-transform .l0-btn:hover{ background: white; color: #333; }
    #house-pillar-transform .l0-btn.active{ background: #ffcc00; color: black; }
    #house-foundation .l0-btn{ background: white; color: #333; }
    #house-foundation .l0-btn:hover{ background: #333; color: white; }
    #house-foundation .l0-btn.active{ background: #d40511; color: white; }

    /* --- CONTEXT BAR --- */
    #context-bar{
      background: #fff; border-bottom: 1px solid #ddd; padding: 10px 30px;
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0; height: 50px;
    }
    #ctx-title{ margin: 0; font-size: 18px; color: #333; font-weight: 700; }
    #ctx-desc{ font-size: 14px; color: #666; margin-left: 20px; border-left: 3px solid #ffcc00; padding-left: 15px; }
    #ctx-owner{ font-size: 11px; color: #fff; background: #333; padding: 4px 10px; border-radius: 4px; font-weight: bold; }

    /* --- L1 CHEVRONS --- */
    #l1-container{
      padding: 15px 30px; background: #fdfdfd; border-bottom: 1px solid #ddd;
      display: flex; flex-wrap: wrap; flex-shrink: 0; min-height: 80px;
    }
    .l1-chevron{
      position: relative; background: #e0e0e0; height: 60px; width: 170px; margin-right: 6px; margin-bottom: 6px;
      display: flex; flex-direction: column; justify-content: center; padding-left: 28px; padding-right: 15px;
      cursor: pointer; transition: all 0.1s; color: #444; user-select: none;
      clip-path: polygon(0% 0%, calc(100% - 15px) 0%, 100% 50%, calc(100% - 15px) 100%, 0% 100%, 15px 50%);
    }
    .l1-chevron.first{ clip-path: polygon(0% 0%, calc(100% - 15px) 0%, 100% 50%, calc(100% - 15px) 100%, 0% 100%); padding-left: 15px; }
    .l1-chevron:hover{ background: #ccc; color: #000; transform: translateY(-2px); }
    .l1-chevron.active{ background: #d40511; color: white; }
    .l1-chevron.active .l1-id{ color: #ffcc00; }
    .l1-id{ font-size: 11px; font-weight: 800; color: #d40511; margin-bottom: 2px; }
    .l1-name{ font-size: 12px; font-weight: 700; line-height: 1.1; }

    /* --- WORKSPACE (L2/L3) --- */
    #workspace{
      flex-grow: 1;
      padding: 40px;
      overflow-x: auto;
      overflow-y: hidden;
      background: #fff;
      display: flex;
      align-items: flex-start;
      white-space: nowrap;
      padding-bottom: 80px;
    }

    /* --- L2 CHEVRON (parametric width) --- */
    .l2-chain-item{
      position: relative;
      width: var(--l2-w);
      min-width: var(--l2-minw);

      margin-left: var(--l2-overlap);

      height: var(--l2-fixed-h);
      min-height: var(--l2-fixed-h);

      clip-path: polygon(
        0% 0%,
        calc(100% - var(--l2-notch)) 0%,
        100% 50%,
        calc(100% - var(--l2-notch)) 100%,
        0% 100%,
        var(--l2-notch) 50%
      );

      background: var(--l2-bg);

      filter:
        drop-shadow(0 0 0.8px rgba(0,0,0,0.45))
        drop-shadow(0 10px 18px rgba(0,0,0,0.12));

      padding: 25px 22px 18px 44px; /* tightened to fit narrower cards */
      display: flex;
      flex-direction: column;
      transition: transform 0.2s, z-index 0s, filter 0.2s, background 0.15s;
    }

    .l2-chain-item::before{
      content:"";
      position:absolute;
      inset:0;
      clip-path: inherit;
      pointer-events:none;
      border: 2px solid var(--l2-border);
      box-shadow: inset 0 0 0 1px rgba(255,204,0,0.18);
    }

    .l2-chain-item.first{
      margin-left: 0;
      clip-path: polygon(0% 0%, calc(100% - var(--l2-notch)) 0%, 100% 50%, calc(100% - var(--l2-notch)) 100%, 0% 100%);
      padding-left: 25px;
    }

    .l2-chain-item:hover{
      background: var(--l2-bg-hover);
      z-index: 100;
      transform: scale(1.01);
      filter:
        drop-shadow(0 0 1px rgba(212,5,17,0.45))
        drop-shadow(0 14px 24px rgba(0,0,0,0.16));
    }

    .l2-bar{ height: 4px; background: #ffcc00; width: 100%; margin-bottom: 10px; border-radius: 2px; flex: 0 0 auto; }
    .l2-id{ color: #d40511; font-size: 11px; font-weight: 800; display: block; margin-bottom: 4px; flex: 0 0 auto; }
    .l2-name{
      color: #222; font-size: 14px; font-weight: 800; white-space: normal;
      line-height: 1.2; margin-bottom: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.08); padding-bottom: 10px;
      flex: 0 0 auto;
    }

    .l3-list{
      flex: 1 1 auto;
      overflow-y: auto;
      padding-right: 10px;
      min-height: 0;
    }

    .l3-item{
      background: #ffffff; margin-bottom: 6px; padding: 8px 10px; border-radius: 4px;
      border-left: 3px solid #ccc; font-size: 12px; white-space: normal; cursor: help;
      transition: all 0.1s;
    }
    .l3-item:hover{ border-left-color: #d40511; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .l3-head{ display: flex; justify-content: space-between; margin-bottom: 2px; font-size: 10px; color: #999; text-transform: uppercase; font-weight: bold; }
    .l3-body{ color: #333; font-weight: 600; }

    .is-hidden{ display: none !important; }

    /* --- TOOLTIP & ERROR --- */
    #tooltip{
      position: fixed; display: none; background: #222; color: #fff; padding: 12px 16px;
      border-radius: 4px; font-size: 12px; max-width: 280px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
      z-index: 1000; pointer-events: none; border-left: 4px solid #ffcc00;
    }
    #tooltip h4{ margin: 0 0 6px 0; color: #ffcc00; font-size: 13px; }
    #tooltip p{ margin: 0 0 8px 0; color: #ddd; line-height: 1.4; }
    #tooltip .meta{ border-top: 1px solid #444; padding-top: 8px; color: #aaa; font-size: 11px; }
    #error-msg{ display: none; padding: 50px; text-align: center; color: red; background: white; }
  </style>
</head>

<body>
  <div id="app-header">
    <div id="header-left">
      <span>DHL eCommerce Value Chain</span>
    </div>
    <div id="header-right">
      <span class="pill">Master Map v4.0</span>
    </div>
  </div>

  <!-- Dropdown filters (L0/L1/L2/L3/Owner + Size S/M/L) -->
  <div id="filter-bar">
    <div class="filter-group">
      <span class="filter-label">L0</span>
      <select id="filter-l0" class="filter">
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-group">
      <span class="filter-label">L1</span>
      <select id="filter-l1" class="filter" disabled>
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-group">
      <span class="filter-label">L2</span>
      <select id="filter-l2" class="filter" disabled>
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-group">
      <span class="filter-label">L3</span>
      <select id="filter-l3" class="filter" disabled>
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-group">
      <span class="filter-label">Owner</span>
      <select id="filter-owner" class="filter">
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-group">
      <span class="filter-label">Size</span>
      <select id="filter-size" class="filter">
        <option value="S" selected>S</option>
        <option value="M">M</option>
        <option value="L">L</option>
      </select>
    </div>

    <button id="clear-filters" type="button">Clear</button>
  </div>

  <div id="mini-nav" onclick="toggleHouse(true)">
    <div id="mini-nav-text">View: <strong>Strategy House</strong></div>
    <div style="font-size:11px; text-transform:uppercase; letter-spacing:1px;">▼ Expand House</div>
  </div>

  <div id="strategy-house-container">
    <div class="house-grid">
      <div id="house-roof" class="house-section">
        <div class="house-title">Manage the Business</div>
        <div class="btn-container" id="cont-manage"></div>
      </div>
      <div id="house-pillar-run" class="house-section">
        <div class="house-title">Run the Business</div>
        <div class="btn-container" id="cont-run"></div>
      </div>
      <div id="house-pillar-transform" class="house-section">
        <div class="house-title">Transform the Business</div>
        <div class="btn-container" id="cont-transform"></div>
      </div>
      <div id="house-foundation" class="house-section">
        <div class="house-title">Foundations & Enablers</div>
        <div class="btn-container" id="cont-foundation"></div>
      </div>
    </div>
  </div>

  <div id="error-msg">Cannot load data.json. Ensure file exists and use a local server.</div>

  <div id="context-bar">
    <div style="display:flex; align-items:center">
      <h2 id="ctx-title">Overview</h2>
      <span id="ctx-desc">Select a Value Stream from the Strategy House to navigate.</span>
    </div>
    <div id="ctx-owner"></div>
  </div>

  <div id="l1-container"></div>

  <div id="workspace">
    <div style="color:#bbb; margin:auto; font-size:18px; text-align:center; padding-top: 60px;">
      <div style="font-size: 50px; color:#e0e0e0; margin-bottom: 20px;">⟰</div>
      Select a Value Stream above to view the process chain.
    </div>
  </div>

  <div id="tooltip"></div>

  <script>
    const houseContainer = document.getElementById('strategy-house-container');
    const miniNav = document.getElementById('mini-nav');
    const miniNavText = document.getElementById('mini-nav-text');
    const l1Container = document.getElementById('l1-container');
    const workspace = document.getElementById('workspace');
    const tooltip = document.getElementById('tooltip');

    // Filters
    const fl0 = document.getElementById('filter-l0');
    const fl1 = document.getElementById('filter-l1');
    const fl2 = document.getElementById('filter-l2');
    const fl3 = document.getElementById('filter-l3');
    const fOwner = document.getElementById('filter-owner');
    const fSize = document.getElementById('filter-size');
    const btnClear = document.getElementById('clear-filters');

    let rootData = null;
    let currentL0 = null;
    let currentL1 = null;

    // Default size (S = 60% width)
    const SIZE_MAP = {
      S: { scale: 0.60, fixedH: 520, overlap: -14, notch: 35 },
      M: { scale: 0.75, fixedH: 520, overlap: -16, notch: 35 },
      L: { scale: 1.00, fixedH: 520, overlap: -18, notch: 35 },
    };

    function applySizePreset(key){
      const preset = SIZE_MAP[key] || SIZE_MAP.S;
      document.documentElement.style.setProperty('--l2-scale', preset.scale);
      document.documentElement.style.setProperty('--l2-fixed-h', preset.fixedH + 'px');
      document.documentElement.style.setProperty('--l2-overlap', preset.overlap + 'px');
      document.documentElement.style.setProperty('--l2-notch', preset.notch + 'px');
    }
    applySizePreset('S');

    d3.json("data.json").then(function(data) {
      if(!data || !data.children) return;
      rootData = data;
      renderHouse(data);
      buildL0Filter(data);
      buildOwnerFilter(data);
    }).catch(err => {
      document.getElementById('error-msg').style.display = 'block';
      houseContainer.style.display = 'none';
    });

    function parseInfo(str) {
      if(!str) return {id:"", name:""};
      const parts = str.split(":");
      return { id: parts[0].trim(), name: parts.slice(1).join(":").trim() || parts[0].trim() };
    }

    function toggleHouse(show) {
      if(show) {
        houseContainer.classList.remove('collapsed');
        miniNav.style.display = 'none';
      } else {
        houseContainer.classList.add('collapsed');
        setTimeout(() => { miniNav.style.display = 'flex'; }, 300);
      }
    }

    function renderHouse(data) {
      const containers = {
        'manage': document.getElementById('cont-manage'),
        'run': document.getElementById('cont-run'),
        'transform': document.getElementById('cont-transform'),
        'foundation': document.getElementById('cont-foundation')
      };

      data.children.sort((a,b) => a.name.localeCompare(b.name));
      data.children.forEach(l0 => {
        const cat = (l0.category || "").toLowerCase();
        let target = containers['foundation'];
        if(cat.includes('manage')) target = containers['manage'];
        else if(cat.includes('run')) target = containers['run'];
        else if(cat.includes('change') || cat.includes('transform')) target = containers['transform'];

        const btn = document.createElement('button');
        const info = parseInfo(l0.name);
        btn.className = 'l0-btn';
        btn.innerHTML = `<span class="l0-btn-id">${info.id}</span><span class="l0-btn-name">${info.name}</span>`;
        btn.onclick = () => selectL0(l0, btn, {syncFilter:true});
        target.appendChild(btn);
      });
    }

    /* =========================
       FILTER BUILDERS
       ========================= */
    function clearSelect(sel, keepFirst=true){
      const first = keepFirst ? sel.options[0].cloneNode(true) : null;
      sel.innerHTML = '';
      if(first) sel.appendChild(first);
    }

    function optionText(node){
      const inf = parseInfo(node.name);
      return `${inf.id} — ${inf.name}`;
    }

    function setEnabled(sel, enabled){
      sel.disabled = !enabled;
      sel.style.opacity = enabled ? '1' : '0.6';
    }

    function buildL0Filter(data){
      clearSelect(fl0, true);
      data.children
        .slice()
        .sort((a,b)=> a.name.localeCompare(b.name))
        .forEach(l0=>{
          const opt = document.createElement('option');
          opt.value = parseInfo(l0.name).id;
          opt.textContent = optionText(l0);
          fl0.appendChild(opt);
        });
    }

    function buildL1Filter(l0Data){
      clearSelect(fl1, true);
      if(!l0Data || !l0Data.children || !l0Data.children.length){
        setEnabled(fl1, false);
        return;
      }
      l0Data.children.forEach(l1=>{
        const opt = document.createElement('option');
        opt.value = parseInfo(l1.name).id;
        opt.textContent = optionText(l1);
        fl1.appendChild(opt);
      });
      setEnabled(fl1, true);
    }

    function buildL2Filter(l1Data){
      clearSelect(fl2, true);
      if(!l1Data || !l1Data.children || !l1Data.children.length){
        setEnabled(fl2, false);
        return;
      }
      l1Data.children.forEach(l2=>{
        const opt = document.createElement('option');
        opt.value = parseInfo(l2.name).id;
        opt.textContent = optionText(l2);
        fl2.appendChild(opt);
      });
      setEnabled(fl2, true);
    }

    function buildL3Filter(l2Data){
      clearSelect(fl3, true);
      if(!l2Data || !l2Data.children || !l2Data.children.length){
        setEnabled(fl3, false);
        return;
      }
      l2Data.children.forEach(l3=>{
        const opt = document.createElement('option');
        opt.value = parseInfo(l3.name).id;
        opt.textContent = optionText(l3);
        fl3.appendChild(opt);
      });
      setEnabled(fl3, true);
    }

    function buildOwnerFilter(data){
      const owners = new Set();
      // Collect owners at all levels (L0..L3)
      (data.children||[]).forEach(l0=>{
        if(l0.owner) owners.add(String(l0.owner).trim());
        (l0.children||[]).forEach(l1=>{
          if(l1.owner) owners.add(String(l1.owner).trim());
          (l1.children||[]).forEach(l2=>{
            if(l2.owner) owners.add(String(l2.owner).trim());
            (l2.children||[]).forEach(l3=>{
              if(l3.owner) owners.add(String(l3.owner).trim());
            });
          });
        });
      });

      clearSelect(fOwner, true);
      Array.from(owners)
        .filter(Boolean)
        .sort((a,b)=>a.localeCompare(b))
        .forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o;
          opt.textContent = o;
          fOwner.appendChild(opt);
        });
    }

    /* =========================
       SELECTION FLOW
       ========================= */
    function selectL0(l0Data, btn, opts={}) {
      currentL0 = l0Data;
      currentL1 = null;

      document.querySelectorAll('.l0-btn').forEach(b => b.classList.remove('active'));
      if(btn) btn.classList.add('active');

      const info = parseInfo(l0Data.name);
      document.getElementById('ctx-title').innerText = `${info.name}`;
      document.getElementById('ctx-desc').innerText = l0Data.description || "No description.";
      document.getElementById('ctx-owner').innerText = (l0Data.owner || "Unassigned").toUpperCase();

      miniNavText.innerHTML = `Active Stream: <strong style="color:#ffcc00">${info.name}</strong>`;
      toggleHouse(false);

      l1Container.innerHTML = '';
      workspace.innerHTML = '<div style="color:#999; margin:auto; font-size:16px; padding-top:60px;">Select a Process Domain (L1 Chevron) to view details.</div>';

      if(l0Data.children) {
        l0Data.children.forEach((l1, idx) => {
          const div = document.createElement('div');
          div.className = 'l1-chevron';
          if(idx === 0) div.classList.add('first');
          const inf = parseInfo(l1.name);
          div.innerHTML = `<span class="l1-id">${inf.id}</span><span class="l1-name">${inf.name}</span>`;
          div.onclick = () => selectL1(l1, div, {syncFilter:true});
          div.onmousemove = (e) => showTooltip(e, inf.name, l1.description, `Owner: ${l1.owner||"-"}`);
          div.onmouseleave = hideTooltip;
          l1Container.appendChild(div);
        });
      }

      // Sync filter cascading
      buildL1Filter(l0Data);
      clearSelect(fl2, true); setEnabled(fl2, false);
      clearSelect(fl3, true); setEnabled(fl3, false);

      if(opts.syncFilter){
        fl0.value = parseInfo(l0Data.name).id;
        fl1.value = "";
        fl2.value = "";
        fl3.value = "";
      }

      applyFiltersToUI();
    }

    function selectL1(l1Data, chevron, opts={}) {
      currentL1 = l1Data;

      document.querySelectorAll('.l1-chevron').forEach(c => c.classList.remove('active'));
      chevron.classList.add('active');
      workspace.innerHTML = '';

      // Render L2 chain
      if(l1Data.children) {
        l1Data.children.forEach((l2, idx) => {
          const inf = parseInfo(l2.name);
          const card = document.createElement('div');
          card.className = 'l2-chain-item';
          if(idx === 0) card.classList.add('first');

          const l2Owner = l2.owner || l1Data.owner || currentL0?.owner || "";
          card.dataset.l2id = inf.id;
          card.dataset.owner = String(l2Owner || "").trim();

          card.innerHTML = `
            <div class="l2-bar"></div>
            <span class="l2-id">${inf.id}</span>
            <span class="l2-name">${inf.name}</span>
            <div class="l3-list" id="l3-list-${idx}"></div>
          `;
          workspace.appendChild(card);

          const list = card.querySelector(`#l3-list-${idx}`);
          if(l2.children && l2.children.length > 0) {
            l2.children.forEach(l3 => {
              const l3Inf = parseInfo(l3.name);
              const item = document.createElement('div');
              item.className = 'l3-item';

              const l3Owner = l3.owner || l2.owner || l1Data.owner || currentL0?.owner || "";
              item.dataset.l3id = l3Inf.id;
              item.dataset.owner = String(l3Owner || "").trim();

              item.innerHTML = `
                <div class="l3-head"><span>${l3Inf.id}</span></div>
                <div class="l3-body">${l3Inf.name}</div>
              `;
              item.onmousemove = (e) => {
                const meta = `<b>Owner:</b> ${l3Owner||"-"}<br><b>Trigger:</b> ${l3.trigger||"-"}<br><b>Outcome:</b> ${l3.outcome||"-"}`;
                showTooltip(e, l3Inf.name, l3.description, meta);
              };
              item.onmouseleave = hideTooltip;

              list.appendChild(item);
            });
          } else {
            list.innerHTML = `<div style="padding:10px; color:#ccc; font-style:italic;">No L3 steps.</div>`;
          }
        });
      }

      // Sync filter cascading
      buildL2Filter(l1Data);
      clearSelect(fl3, true); setEnabled(fl3, false);

      if(opts.syncFilter){
        fl1.value = parseInfo(l1Data.name).id;
        fl2.value = "";
        fl3.value = "";
      }

      applyFiltersToUI();
    }

    /* =========================
       FILTER APPLICATION
       ========================= */
    function applyFiltersToUI(){
      const ownerVal = (fOwner.value || "").trim();
      const l2Val = (fl2.value || "").trim();
      const l3Val = (fl3.value || "").trim();

      // L2 cards
      const l2Cards = workspace.querySelectorAll('.l2-chain-item');
      if(l2Cards.length){
        l2Cards.forEach(card=>{
          const cardOwner = (card.dataset.owner || "").trim();
          const cardL2 = (card.dataset.l2id || "").trim();

          // Apply owner + L2 filters at card level
          let showCard = true;
          if(ownerVal && cardOwner !== ownerVal) showCard = false;
          if(l2Val && cardL2 !== l2Val) showCard = false;

          // Apply L3 filter inside
          const l3Items = card.querySelectorAll('.l3-item');
          let anyL3 = false;

          l3Items.forEach(item=>{
            const itemOwner = (item.dataset.owner || "").trim();
            const itemL3 = (item.dataset.l3id || "").trim();

            let showItem = true;
            if(ownerVal && itemOwner !== ownerVal) showItem = false;
            if(l3Val && itemL3 !== l3Val) showItem = false;

            item.classList.toggle('is-hidden', !showItem);
            if(showItem) anyL3 = true;
          });

          // If L3 filter is set, hide cards that have no visible L3
          if(l3Val && !anyL3) showCard = false;

          card.classList.toggle('is-hidden', !showCard);
        });
      }

      // Keep L3 dropdown options in sync with selected L2 (optional / simple approach)
      // If L2 dropdown has value, populate L3 dropdown from that L2 node
      if(currentL1 && fl2.value){
        const l2Node = (currentL1.children || []).find(n => parseInfo(n.name).id === fl2.value);
        buildL3Filter(l2Node || null);
        setEnabled(fl3, !!l2Node);
      } else {
        // If no specific L2 selected, disable L3 filter unless already populated
        if(!fl3.value){
          clearSelect(fl3, true);
          setEnabled(fl3, false);
        }
      }
    }

    /* =========================
       FILTER EVENTS
       ========================= */
    fl0.addEventListener('change', () => {
      const id = fl0.value;
      if(!rootData) return;

      if(!id){
        // Clear selection: show house expanded again
        toggleHouse(true);
        l1Container.innerHTML = '';
        workspace.innerHTML = '<div style="color:#bbb; margin:auto; font-size:18px; text-align:center; padding-top: 60px;"><div style="font-size: 50px; color:#e0e0e0; margin-bottom: 20px;">⟰</div>Select a Value Stream above to view the process chain.</div>';
        clearSelect(fl1,true); setEnabled(fl1,false);
        clearSelect(fl2,true); setEnabled(fl2,false);
        clearSelect(fl3,true); setEnabled(fl3,false);
        currentL0 = null; currentL1 = null;
        return;
      }

      const l0Node = (rootData.children || []).find(n => parseInfo(n.name).id === id);
      if(!l0Node) return;

      // Select L0 programmatically (no need to find the exact button)
      selectL0(l0Node, null, {syncFilter:false});
      fl1.value = "";
      fl2.value = "";
      fl3.value = "";
      setEnabled(fl1,true);
      setEnabled(fl2,false);
      setEnabled(fl3,false);
      applyFiltersToUI();
    });

    fl1.addEventListener('change', () => {
      if(!currentL0) return;
      const id = fl1.value;

      if(!id){
        // back to L1 selection view only
        workspace.innerHTML = '<div style="color:#999; margin:auto; font-size:16px; padding-top:60px;">Select a Process Domain (L1 Chevron) to view details.</div>';
        clearSelect(fl2,true); setEnabled(fl2,false);
        clearSelect(fl3,true); setEnabled(fl3,false);
        currentL1 = null;
        applyFiltersToUI();
        return;
      }

      const l1Node = (currentL0.children || []).find(n => parseInfo(n.name).id === id);
      if(!l1Node) return;

      // Select L1 programmatically
      // Try to highlight matching chevron if present
      const chevs = Array.from(l1Container.querySelectorAll('.l1-chevron'));
      const match = chevs.find(el => (el.querySelector('.l1-id')?.textContent || "").trim() === id);
      selectL1(l1Node, match || chevs[0], {syncFilter:false});

      fl2.value = "";
      fl3.value = "";
      setEnabled(fl2,true);
      setEnabled(fl3,false);
      applyFiltersToUI();
    });

    fl2.addEventListener('change', () => {
      // L2 filter applied on cards; L3 dropdown gets populated by selected L2 (if any)
      fl3.value = "";
      applyFiltersToUI();
    });

    fl3.addEventListener('change', () => {
      applyFiltersToUI();
    });

    fOwner.addEventListener('change', () => {
      applyFiltersToUI();
    });

    fSize.addEventListener('change', () => {
      applySizePreset(fSize.value);
    });

    btnClear.addEventListener('click', () => {
      fl0.value = "";
      fl1.value = ""; clearSelect(fl1,true); setEnabled(fl1,false);
      fl2.value = ""; clearSelect(fl2,true); setEnabled(fl2,false);
      fl3.value = ""; clearSelect(fl3,true); setEnabled(fl3,false);
      fOwner.value = "";
      fSize.value = "S";
      applySizePreset("S");

      // Reset UI
      toggleHouse(true);
      l1Container.innerHTML = '';
      workspace.innerHTML = '<div style="color:#bbb; margin:auto; font-size:18px; text-align:center; padding-top: 60px;"><div style="font-size: 50px; color:#e0e0e0; margin-bottom: 20px;">⟰</div>Select a Value Stream above to view the process chain.</div>';
      currentL0 = null; currentL1 = null;
    });

    /* =========================
       TOOLTIP
       ========================= */
    function showTooltip(e, title, desc, meta) {
      tooltip.style.display = 'block';
      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY + 15) + 'px';
      tooltip.innerHTML = `<h4>${title}</h4><p>${desc||""}</p><div class="meta">${meta||""}</div>`;
    }
    function hideTooltip() { tooltip.style.display = 'none'; }
  </script>
</body>
</html>
