<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DHL eCommerce · Customer Journey Map</title>

  <style>
    :root{
      --dhl-red:#D40511;
      --dhl-yellow:#FFCC00;

      --ink:#101828;
      --muted:#667085;
      --bg:#F5F7FA;
      --panel:#FFFFFF;
      --line:rgba(16,24,40,0.12);

      --header-h:56px;
      --deck-collapsed-h:48px;
      --deck-expanded-h:min(42vh, 520px);

      --lane-label-w:280px;

      --tile-h:44px;
      --tile-min-w:220px;

      --shadow: 0 10px 26px rgba(16,24,40,0.10);
      --shadow-2: 0 18px 44px rgba(16,24,40,0.14);

      --radius:14px;

      --belt-h: 68px;

      /* ZERO-SCROLL: we cap lane heights */
      --gridLaneRows: 2;                  /* tiles per stage column visible */
      --gridLaneRowH: 50px;               /* height per tile row in grid lanes */
      --gridLaneH: calc(var(--gridLaneRows) * var(--gridLaneRowH) + 18px); /* + padding */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      color:var(--ink);
      background:var(--bg);
      overflow:hidden;
    }

    .app{ height:100%; display:flex; flex-direction:column; }

    .topbar{
      height:var(--header-h);
      background:var(--dhl-red);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      gap:12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.18);
      z-index:50;
      flex:0 0 auto;
    }
    .topbar .title{
      font-weight:900;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:850;
      white-space:nowrap;
    }

    .right{ display:flex; align-items:center; gap:10px; min-width:0; }

    .search{ position:relative; width: 420px; max-width: 42vw; min-width: 260px; }
    .search input{
      width:100%;
      height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.25);
      outline:none;
      padding:0 12px;
      font-size:12px;
      font-weight:750;
      background: rgba(255,255,255,0.12);
      color:#fff;
    }
    .search input::placeholder{ color: rgba(255,255,255,0.78); font-weight:700; }
    .search input:focus{
      box-shadow:0 0 0 3px rgba(255,204,0,0.35);
      border-color: rgba(255,204,0,0.8);
    }

    .split{ position:relative; flex:1 1 auto; min-height:0; }

    .mapWrap{
      position:absolute;
      inset:0 0 var(--deck-collapsed-h) 0;
      display:flex;
      flex-direction:column;
      min-height:0;
      transition: inset 240ms ease;
    }
    .mapWrap.deckOpen{ inset:0 0 var(--deck-expanded-h) 0; }

    .mapHeader{
      background:var(--panel);
      border-bottom:1px solid var(--line);
      box-shadow: 0 4px 14px rgba(16,24,40,0.06);
      z-index:20;
      flex:0 0 auto;
    }

    .stageGrid{
      display:grid;
      grid-template-columns: var(--lane-label-w) repeat(7, minmax(170px, 1fr));
      align-items:stretch;
      gap:0;
    }

    .stageCorner{
      padding:10px 12px;
      border-right:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .stageCorner .hint{
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      line-height:1.2;
    }

    .stageCell{
      padding:10px 10px 12px 10px;
      border-right:1px solid var(--line);
    }
    .stageCell:last-child{ border-right:none; }

    .stageNo{ font-size:11px; font-weight:950; color:var(--dhl-red); margin-bottom:4px; }
    .stageName{ font-size:13px; font-weight:950; line-height:1.15; margin-bottom:6px; }
    .stageVoice{ font-size:11px; font-weight:850; color:var(--muted); }

    /* ZERO-SCROLL: keep map visible; allow scroll only if user expands/collapses a lot */
    .mapBody{
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      padding:8px 0;
    }

    .laneRow{
      display:grid;
      grid-template-columns: var(--lane-label-w) 1fr;
      gap:0;
      align-items:stretch;
      border-bottom:1px solid rgba(16,24,40,0.08);
      background: rgba(255,255,255,0.35);
    }

    .laneLabel{
      position:sticky;
      left:0;
      z-index:10;
      background: linear-gradient(180deg, #fff 0%, #F6F8FC 100%);
      border-right:1px solid var(--line);
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .laneLabelTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .laneTitle{
      font-size:13px;
      font-weight:950;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .laneCode{
      font-size:11px;
      font-weight:950;
      color:var(--dhl-red);
      background: rgba(212,5,17,0.08);
      border:1px solid rgba(212,5,17,0.18);
      border-radius:999px;
      padding:3px 8px;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .laneSub{ font-size:11px; font-weight:800; color:var(--muted); line-height:1.25; }

    .laneControls{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .btn{
      height:28px;
      border-radius:10px;
      padding:0 10px;
      border:1px solid rgba(16,24,40,0.14);
      background:#fff;
      color:#1f2937;
      font-size:11px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .btn:hover{ background:#FFF9E6; border-color: rgba(255,204,0,0.6); }
    .btn:active{ transform: translateY(1px); }

    /* ===== GRID LANE (Story lanes) ===== */
    .laneGrid{
      display:grid;
      grid-template-columns: repeat(7, minmax(170px, 1fr));
      gap:10px;
      padding:10px 10px 12px 10px;
      align-content:start;
    }

    .gridLaneFixed{
      height: var(--gridLaneH);
      overflow:hidden; /* critical: prevents vertical growth */
      border-radius:14px;
    }

    .stageCol{
      position:relative;
      height: calc(var(--gridLaneRows) * var(--gridLaneRowH));
      padding:2px 0 2px 0;
      display:grid;
      grid-template-rows: repeat(var(--gridLaneRows), var(--gridLaneRowH));
      gap:6px;
      align-content:start;
    }

    /* overflow chip */
    .moreChip{
      position:absolute;
      right:0;
      bottom:-2px;
      transform: translateY(100%);
      height:28px;
      padding:0 10px;
      border-radius:999px;
      background:#fff;
      border:1px dashed rgba(16,24,40,0.22);
      font-size:11px;
      font-weight:950;
      color:var(--muted);
      cursor:pointer;
      display:none;
      align-items:center;
      gap:6px;
      box-shadow: 0 8px 16px rgba(16,24,40,0.08);
      white-space:nowrap;
      user-select:none;
    }
    .moreChip.show{ display:inline-flex; }
    .moreChip:hover{ background:#FFF9E6; border-color: rgba(255,204,0,0.7); color:#7a5a00; }

    /* Continuous tile row (for span in story lanes) */
    .continuousRow{
      grid-column:1/-1;
      display:flex;
      gap:10px;
      align-items:center;
      height: 42px;
      padding:0 6px;
      margin-top:6px;
    }
    .continuousLabel{
      font-size:11px;
      font-weight:950;
      color:var(--muted);
      white-space:nowrap;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(16,24,40,0.12);
      background:#fff;
    }
    .continuousRow .tile{ height:42px; }

    /* ===== BELT LANE (P2R / Resources) ===== */
    .beltWrap{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      gap:10px;
      height: var(--belt-h);
      padding:10px;
      border:1px solid rgba(16,24,40,0.10);
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.90) 0%, rgba(247,248,251,0.85) 100%);
      overflow:hidden;
    }
    .belt{
      display:flex;
      gap:10px;
      align-items:center;
      overflow:hidden; /* ZERO-SCROLL: no horizontal scroll until user clicks Start/End */
      padding-bottom:2px;
      flex: 1 1 auto;
      min-width:0;
    }

    .beltHint{
      flex:0 0 auto;
      font-size:11px;
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(16,24,40,0.12);
      background:#fff;
    }

    /* ===== FOUNDATION CAPSULES ===== */
    .capsuleRow{
      grid-column:1/-1;
      display:flex;
      gap:10px;
      align-items:stretch;
      height: var(--gridLaneH);
      overflow:hidden;
    }
    .capsule{
      flex: 1 1 0;
      min-width: 240px;
      border:1px solid rgba(16,24,40,0.12);
      border-radius:14px;
      background:#fff;
      padding:8px 8px;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
      box-shadow: 0 10px 18px rgba(16,24,40,0.06);
    }
    .capsuleHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .capsuleTitle{
      font-size:12px;
      font-weight:950;
      color:var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .capsuleCount{
      font-size:11px;
      font-weight:950;
      color:var(--muted);
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(16,24,40,0.12);
      background:#F7F8FB;
      white-space:nowrap;
    }
    .capsuleBody{
      display:grid;
      grid-template-rows: repeat(2, 1fr);
      gap:6px;
      min-height:0;
    }

    /* ===== L1 Chevron Tile ===== */
    .tile{
      height: var(--tile-h);
      min-width: var(--tile-min-w);
      width: 100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 14px 8px 16px;
      cursor:pointer;
      user-select:none;
      border-radius:14px;
      background: linear-gradient(180deg, #FFE89A 0%, var(--dhl-yellow) 88%);
      color:#1a1a1a;
      border:1px solid rgba(16,24,40,0.14);
      box-shadow: 0 8px 14px rgba(16,24,40,0.09);
      clip-path: polygon(
        0% 0%,
        calc(100% - 18px) 0%,
        100% 50%,
        calc(100% - 18px) 100%,
        0% 100%,
        18px 50%
      );
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      overflow:hidden;
    }
    .tile:hover{
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(16,24,40,0.12);
      filter: brightness(0.99);
    }
    .tile.active{
      background: var(--dhl-red);
      color:#fff;
      border-color: rgba(0,0,0,0.18);
      box-shadow: 0 0 0 3px rgba(255,204,0,0.65), 0 14px 26px rgba(16,24,40,0.14);
    }
    .tile.active .tileId{ color: var(--dhl-yellow); border-color: rgba(255,204,0,0.55); background: rgba(0,0,0,0.22); }
    .tile.active .tileStageChip{ border-color: rgba(255,204,0,0.55); color: #fff; background: rgba(0,0,0,0.18); }

    .tileId{
      flex:0 0 auto;
      font-size:11px;
      font-weight:950;
      color:var(--dhl-red);
      background: rgba(255,255,255,0.65);
      border:1px solid rgba(212,5,17,0.20);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
      max-width: 52%;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tileName{
      font-size:12px;
      font-weight:900;
      line-height:1.1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      min-width:0;
      flex: 1 1 auto;
    }

    .tileStageChip{
      flex: 0 0 auto;
      font-size:10px;
      font-weight:950;
      color: #1f2937;
      background: rgba(255,255,255,0.75);
      border: 1px solid rgba(16,24,40,0.16);
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }

    /* Collapsed lane */
    .laneRow.collapsed .laneGrid{ display:none !important; }
    .collapsedNote{
      padding:10px 10px 12px 10px;
      color:var(--muted);
      font-weight:850;
      font-size:12px;
    }

    /* ===== Drawer ===== */
    .drawerBackdrop{
      position:fixed;
      inset:0;
      background: rgba(16,24,40,0.42);
      display:none;
      z-index:999;
    }
    .drawerBackdrop.show{ display:block; }

    .drawer{
      position:fixed;
      top: calc(var(--header-h) + 12px);
      right: 12px;
      width: min(520px, 92vw);
      height: min(70vh, 740px);
      background:#fff;
      border:1px solid rgba(16,24,40,0.14);
      border-radius:16px;
      box-shadow: var(--shadow-2);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      z-index:1000;
    }
    .drawerHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      background:#F7F8FB;
      border-bottom:1px solid var(--line);
    }
    .drawerTitle{
      font-size:13px;
      font-weight:950;
      margin:0;
      line-height:1.15;
    }
    .drawerSub{
      font-size:11px;
      font-weight:850;
      color:var(--muted);
      margin-top:4px;
    }
    .drawerClose{
      height:30px;
      padding:0 10px;
      border-radius:10px;
      border:1px solid rgba(16,24,40,0.14);
      background:#fff;
      font-size:11px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .drawerClose:hover{ background:#FFF9E6; border-color: rgba(255,204,0,0.6); }

    .drawerBody{
      padding:10px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .drawerSection{
      border:1px solid rgba(16,24,40,0.10);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
    }
    .drawerSectionHead{
      padding:10px 10px;
      background:#fff;
      border-bottom:1px solid rgba(16,24,40,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .drawerSectionTitle{
      font-size:12px;
      font-weight:950;
      color:var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .drawerSectionCount{
      font-size:11px;
      font-weight:950;
      color:var(--muted);
      border:1px solid rgba(16,24,40,0.12);
      background:#F7F8FB;
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
    }
    .drawerList{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .drawerList .tile{
      clip-path:none; /* drawer list: simpler rectangle */
      border-radius:12px;
    }

    /* ===== Deck ===== */
    .deck{
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      height:var(--deck-collapsed-h);
      background:var(--panel);
      border-top: 3px solid var(--dhl-yellow);
      box-shadow: 0 -12px 30px rgba(16,24,40,0.12);
      transition: height 240ms ease;
      z-index:40;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .deck.open{ height:var(--deck-expanded-h); }

    .deckHandle{
      height:var(--deck-collapsed-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:0 14px;
      cursor:pointer;
      user-select:none;
    }
    .deckHandleLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .deckIcon{
      width:30px;height:30px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(212,5,17,0.10);
      border:1px solid rgba(212,5,17,0.18);
      font-weight:950;
      color:var(--dhl-red);
      flex:0 0 auto;
    }
    .deckTitle{
      font-size:12px;
      font-weight:950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 62vw;
    }
    .deckHint{
      font-size:11px;
      font-weight:850;
      color:var(--muted);
      white-space:nowrap;
      flex:0 0 auto;
    }

    .deckBody{
      border-top:1px solid var(--line);
      padding:12px 14px 14px 14px;
      overflow:auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .l1Meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .l1Heading{ min-width: 280px; flex: 1 1 380px; }
    .l1Heading .h1{ font-size:16px; font-weight:980; margin:0 0 4px 0; line-height:1.15; }
    .l1Heading .desc{ margin:0; font-size:12px; color:var(--muted); font-weight:750; line-height:1.4; max-width: 1100px; }

    .metaPills{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; flex: 0 0 auto; }
    .metaPill{
      font-size:11px;
      font-weight:900;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(16,24,40,0.14);
      background:#F7F8FB;
      color:#1f2937;
      white-space:nowrap;
    }
    .metaPill.owner{ background:#111827; color:#fff; border-color: rgba(0,0,0,0.16); }
    .metaPill.id{ background: rgba(212,5,17,0.08); border-color: rgba(212,5,17,0.18); color: var(--dhl-red); }

    .l2Chain{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom:4px;
      scroll-snap-type:x mandatory;
    }
    .l2Block{
      flex: 0 0 min(380px, 92vw);
      background:#fff;
      border:1px solid rgba(16,24,40,0.12);
      border-radius:14px;
      box-shadow: 0 10px 20px rgba(16,24,40,0.06);
      padding:10px 10px 8px 10px;
      scroll-snap-align:start;
      min-height: 120px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .l2Header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px solid rgba(16,24,40,0.08);
    }
    .l2HeaderLeft{ min-width:0; }
    .l2Id{ font-size:11px; font-weight:950; color:var(--dhl-red); margin-bottom:4px; }
    .l2Name{
      font-size:13px;
      font-weight:950;
      line-height:1.15;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 320px;
    }

    .l3List{ display:flex; flex-direction:column; gap:6px; padding-top:2px; }
    .l3Item{
      border-left: 3px solid rgba(16,24,40,0.18);
      background:#FBFCFE;
      border-radius:10px;
      padding:8px 10px;
      border-top:1px solid rgba(16,24,40,0.06);
      border-right:1px solid rgba(16,24,40,0.06);
      border-bottom:1px solid rgba(16,24,40,0.06);
    }
    .l3Top{
      font-size:10px;
      font-weight:950;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.3px;
      margin-bottom:3px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .l3Name{ font-size:12px; font-weight:850; margin:0; line-height:1.25; color:#111827; }

    .empty{ padding:14px 12px; color:var(--muted); font-weight:800; font-size:12px; }
    .error{
      margin:12px 14px;
      padding:12px 12px;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(180,35,24,0.22);
      color:#b42318;
      font-weight:900;
      box-shadow: var(--shadow);
    }

    @media (max-width: 980px){
      :root{ --lane-label-w: 240px; }
      .search{ width: 320px; }
    }
    @media (max-width: 720px){
      :root{ --lane-label-w: 210px; }
      .pill{ display:none; }
      .search{ width: 240px; min-width: 200px; }
      .deckTitle{ max-width: 56vw; }
      .capsule{ min-width: 200px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <span>DHL eCommerce · Customer Journey Map</span>
        <span class="pill">Zero-scroll first view · Overflow via Drawer</span>
      </div>
      <div class="right">
        <div class="search">
          <input id="searchInput" placeholder="Search ID or name… e.g., O2D_04, customs, onboarding" autocomplete="off" />
        </div>
      </div>
    </div>

    <div class="split">
      <!-- TOP: MAP -->
      <div id="mapWrap" class="mapWrap">
        <div class="mapHeader">
          <div class="stageGrid" id="stageHeader"></div>
        </div>

        <div class="mapBody" id="mapBody"></div>

        <div id="errBox" class="error" style="display:none;"></div>
      </div>

      <!-- BOTTOM: DECK -->
      <div id="deck" class="deck" aria-live="polite">
        <div id="deckHandle" class="deckHandle" title="Click to expand/collapse">
          <div class="deckHandleLeft">
            <div class="deckIcon">≡</div>
            <div id="deckHandleTitle" class="deckTitle">Select an L1 chevron to view details</div>
          </div>
          <div id="deckHint" class="deckHint">▲ Expand</div>
        </div>

        <div id="deckBody" class="deckBody" style="display:none;"></div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawerBackdrop" class="drawerBackdrop" aria-hidden="true"></div>
  <div id="drawer" class="drawer" style="display:none;" role="dialog" aria-modal="true" aria-label="Lane Drawer">
    <div class="drawerHead">
      <div>
        <div id="drawerTitle" class="drawerTitle">More items</div>
        <div id="drawerSub" class="drawerSub"></div>
      </div>
      <button id="drawerClose" class="drawerClose">Close</button>
    </div>
    <div id="drawerBody" class="drawerBody"></div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const STAGES = [
      { no: 1, name: "Awareness & Plan", voice: "I discover" },
      { no: 2, name: "Offer & Account", voice: "I agree" },
      { no: 3, name: "Onboarding", voice: "I integrate" },
      { no: 4, name: "Booking & Collect", voice: "I ship" },
      { no: 5, name: "Export & Transit", voice: "It moves" },
      { no: 6, name: "Import & Last Mile", voice: "I receive" },
      { no: 7, name: "Post-Shipment", voice: "I pay/return" }
    ];

    // renderMode:
    // - "gridStory": stage columns with caps (+n drawer)
    // - "belt": compact belt showing top N + (+n drawer)
    // - "foundationCapsules": grouped L0 capsules with caps (+n drawer)
    const LANES = [
      { key: "COMM", label: "Commercial", l0Codes: ["L2C"], sub: "Top Priority", laneCode: "L2C", renderMode:"gridStory" },
      { key: "OPS",  label: "Operations", l0Codes: ["O2D"], sub: "Core Logistics", laneCode: "O2D", renderMode:"gridStory" },
      { key: "DES",  label: "Design", l0Codes: ["D2O"], sub: "Network & Product Design", laneCode: "D2O", renderMode:"gridStory" },

      { key: "RESO", label: "Resolution", l0Codes: ["P2R"], sub: "Issue Management", laneCode: "P2R", renderMode:"belt" },
      { key: "RSRC", label: "Resources", l0Codes: ["S2P","H2R"], sub: "Sourcing & HR", laneCode: "S2P & H2R", renderMode:"belt" },

      { key: "FND",  label: "Foundation", l0Codes: ["S2E","GRC","ITF","EA_PM","DA","I2P","TRF","R2R"], sub: "Strategy & Enablers", laneCode: "S2E, GRC, IT, EA, DA", renderMode:"foundationCapsules" },
    ];

    // Visible caps (initial view)
    const STORY_MAX_PER_STAGE = 2;    // each stage column shows max 2 tiles
    const BELT_VISIBLE = 4;           // belt lanes show first 4 tiles

    // Continuous span logic:
    // - Commercial CS & Claims spans booking -> post shipment
    // - All P2R spans booking -> post shipment
    // (In gridStory, we show continuous as a dedicated "continuous row" tile, never consuming per-stage slots.)
    const SPAN_RULES = [
      { match: { l0: "L2C", l1: "L2C_08" }, span: { from: 4, to: 7 } },
      { match: { l0: "P2R" }, span: { from: 4, to: 7 } }
    ];

    /***********************
     * Utilities
     ***********************/
    const $ = (sel) => document.querySelector(sel);
    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

    function parseInfo(name){
      if(!name) return { id:"", name:"" };
      const parts = String(name).split(":");
      const id = parts[0].trim();
      const nm = parts.slice(1).join(":").trim() || id;
      return { id, name: nm };
    }

    function safeChildren(n){
      return (n && Array.isArray(n.children)) ? n.children : [];
    }

    function getL0Map(root){
      const m = new Map();
      safeChildren(root).forEach(l0=>{
        const inf = parseInfo(l0.name);
        if(inf.id) m.set(inf.id, l0);
      });
      return m;
    }

    function extractTrailingNumber(id){
      const m = String(id || "").match(/_(\d+)\s*$/);
      return m ? Number(m[1]) : null;
    }

    function getSpanFor(l0Id, l1Id){
      for(const r of SPAN_RULES){
        const m = r.match || {};
        const okL0 = (m.l0 == null) || (m.l0 === l0Id);
        const okL1 = (m.l1 == null) || (m.l1 === l1Id);
        if(okL0 && okL1) return r.span;
      }
      return null;
    }

    /***********************
     * Stage mapping (heuristics; still no text hardcoding)
     ***********************/
    function colForL1(l0Id, l1Node){
      const { id: l1Id, name: l1Name } = parseInfo(l1Node.name);
      const n = extractTrailingNumber(l1Id);

      if(l0Id === "L2C"){
        if(n === 1) return 1;
        if(n === 2) return 2;
        if(n === 3) return 2;
        if(n === 4) return 3;
        if(n === 5) return 4;
        if(n === 6) return 7;
        if(n === 7) return 7;
        if(n === 8) return 6; // continuous row will override
        return 3;
      }

      if(l0Id === "O2D"){
        if(n === 1) return 4;
        if(n === 2) return 4;
        if(n === 3) return 4;
        if(n === 4) return 5;
        if(n === 5) return 5;
        if(n === 6) return 5;
        if(n === 7) return 6;
        if(n === 8) return 6;
        if(n === 9) return 6;
        if(n === 10) return 6;
        if(n === 11) return 6;
        if(n === 12) return 7;
        return 5;
      }

      if(l0Id === "D2O"){
        if(n === 1) return 2;
        if(n === 2) return 2;
        if(n === 3) return 3;
        if(n === 4) return 4;
        if(n === 5) return 4;
        if(n === 6) return 5;
        if(n === 7) return 6;
        if(n === 8) return 7;
        return 3;
      }

      // fallback for enablers
      const nm = (l1Name || "").toLowerCase();
      if(nm.includes("strategy") || nm.includes("governance")) return 1;
      if(nm.includes("architecture") || nm.includes("portfolio")) return 2;
      if(nm.includes("platform") || nm.includes("integration") || nm.includes("data")) return 3;
      if(nm.includes("security") || nm.includes("risk") || nm.includes("compliance")) return 1;
      return 2;
    }

    function stageChipText(l0Id, l1Id, l1Node){
      const span = getSpanFor(l0Id, l1Id);
      if(span) return `S${span.from}–S${span.to}`;
      const c = colForL1(l0Id, l1Node);
      return `S${c}`;
    }

    /***********************
     * State
     ***********************/
    let ROOT = null;
    let L0MAP = null;

    const laneCollapsed = {}; // laneKey => boolean

    // Drawer state
    let drawerContext = null; // { laneKey, title, subtitle, sections:[...] }

    /***********************
     * Render: Header
     ***********************/
    function renderStageHeader(){
      const wrap = $("#stageHeader");
      wrap.innerHTML = "";

      const corner = document.createElement("div");
      corner.className = "stageCorner";
      corner.innerHTML = `
        <div class="hint">
          <div style="font-weight:950;color:var(--ink);">Swimlanes</div>
          <div>Initial view fits screen · overflow opens drawer</div>
        </div>
        <div class="laneCode">L0 / Value Chain</div>
      `;
      wrap.appendChild(corner);

      STAGES.forEach(s=>{
        const cell = document.createElement("div");
        cell.className = "stageCell";
        cell.innerHTML = `
          <div class="stageNo">Step ${esc(s.no)}</div>
          <div class="stageName">${esc(s.name)}</div>
          <div class="stageVoice">${esc(s.voice)}</div>
        `;
        wrap.appendChild(cell);
      });
    }

    /***********************
     * Tile builder
     ***********************/
    function buildTile({ l0Id, l1Id, l1Name, l1Node }, { showStageChip=false }){
      const tile = document.createElement("div");
      tile.className = "tile";
      tile.dataset.l0 = l0Id;
      tile.dataset.l1 = l1Id;

      const chip = stageChipText(l0Id, l1Id, l1Node);

      tile.innerHTML = `
        <span class="tileId">${esc(l1Id)}</span>
        <span class="tileName" title="${esc(l1Name)}">${esc(l1Name)}</span>
        ${showStageChip ? `<span class="tileStageChip">${esc(chip)}</span>` : ``}
      `;

      tile.addEventListener("click", () => {
        selectL1(l0Id, l1Node);
        highlightActiveTile(l0Id, l1Id);
        closeDrawer();
      });

      return tile;
    }

    function highlightActiveTile(l0Id, l1Id){
      document.querySelectorAll(".tile").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(`.tile[data-l0="${CSS.escape(l0Id)}"][data-l1="${CSS.escape(l1Id)}"]`).forEach(t => t.classList.add("active"));
    }

    /***********************
     * Drawer
     ***********************/
    const drawer = $("#drawer");
    const drawerBackdrop = $("#drawerBackdrop");
    const drawerTitle = $("#drawerTitle");
    const drawerSub = $("#drawerSub");
    const drawerBody = $("#drawerBody");
    const drawerClose = $("#drawerClose");

    function openDrawer(ctx){
      drawerContext = ctx;
      drawerTitle.textContent = ctx.title || "More items";
      drawerSub.textContent = ctx.subtitle || "";

      drawerBody.innerHTML = "";

      (ctx.sections || []).forEach(sec => {
        const section = document.createElement("div");
        section.className = "drawerSection";

        section.innerHTML = `
          <div class="drawerSectionHead">
            <div class="drawerSectionTitle">${esc(sec.title || "")}</div>
            <div class="drawerSectionCount">${esc(sec.countText || "")}</div>
          </div>
          <div class="drawerList"></div>
        `;

        const list = section.querySelector(".drawerList");
        (sec.items || []).forEach(it => {
          const tile = buildTile(it, { showStageChip: true });
          list.appendChild(tile);
        });

        drawerBody.appendChild(section);
      });

      drawer.style.display = "flex";
      drawerBackdrop.classList.add("show");
      drawerBackdrop.setAttribute("aria-hidden","false");
    }

    function closeDrawer(){
      drawer.style.display = "none";
      drawerBackdrop.classList.remove("show");
      drawerBackdrop.setAttribute("aria-hidden","true");
      drawerContext = null;
    }

    drawerClose.addEventListener("click", closeDrawer);
    drawerBackdrop.addEventListener("click", closeDrawer);
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeDrawer();
    });

    /***********************
     * Render: Map
     ***********************/
    function renderMap(){
      const body = $("#mapBody");
      body.innerHTML = "";

      for(const lane of LANES){
        const row = document.createElement("div");
        row.className = "laneRow";
        row.dataset.laneKey = lane.key;

        if(laneCollapsed[lane.key]) row.classList.add("collapsed");

        // label
        const label = document.createElement("div");
        label.className = "laneLabel";

        const isBelt = lane.renderMode === "belt";

        label.innerHTML = `
          <div class="laneLabelTop">
            <div class="laneTitle">${esc(lane.label)}</div>
            <span class="laneCode">${esc(lane.laneCode)}</span>
          </div>
          <div class="laneSub">${esc(lane.sub || "")}</div>
          <div class="laneControls">
            <button class="btn" data-action="toggle" data-lane="${esc(lane.key)}">
              ${laneCollapsed[lane.key] ? "Expand" : "Collapse"}
            </button>
            ${isBelt ? `
              <button class="btn" data-action="home" data-lane="${esc(lane.key)}">⟸ Start</button>
              <button class="btn" data-action="end" data-lane="${esc(lane.key)}">End ⟹</button>
            ` : ""}
          </div>
        `;

        const content = document.createElement("div");
        content.className = "laneGrid";

        // Collect all L1 items for lane
        const allItems = [];
        for(const l0Code of lane.l0Codes){
          const l0Node = L0MAP.get(l0Code);
          if(!l0Node) continue;
          for(const l1 of safeChildren(l0Node)){
            const i1 = parseInfo(l1.name);
            allItems.push({
              l0Id: l0Code,
              l1Id: i1.id,
              l1Name: i1.name,
              l1Node: l1
            });
          }
        }

        if(laneCollapsed[lane.key]){
          const note = document.createElement("div");
          note.className = "collapsedNote";
          note.textContent = allItems.length ? `${allItems.length} L1 processes hidden.` : "No processes found for this lane.";
          content.appendChild(note);
        } else {
          if(!allItems.length){
            content.innerHTML = `<div class="empty" style="grid-column:1/-1;">No processes found for this lane in data.json.</div>`;
          } else {
            if(lane.renderMode === "belt"){
              renderBeltLane(content, lane, allItems);
            } else if(lane.renderMode === "foundationCapsules"){
              renderFoundationCapsules(content, lane, allItems);
            } else {
              renderGridStoryLane(content, lane, allItems);
            }
          }
        }

        row.appendChild(label);
        row.appendChild(content);
        body.appendChild(row);
      }

      // lane control hooks
      body.querySelectorAll(".btn[data-action]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const action = btn.dataset.action;
          const laneKey = btn.dataset.lane;

          if(action === "toggle"){
            laneCollapsed[laneKey] = !laneCollapsed[laneKey];
            renderMap();
            return;
          }

          if(action === "home" || action === "end"){
            // For belt lanes, we keep overflow hidden on initial view; Start/End will reveal by scrolling container itself.
            // Implementation: find belt and switch it to scrollable by temporarily setting overflow-x.
            const belt = body.querySelector(`.belt[data-belt-lane="${CSS.escape(laneKey)}"]`);
            if(!belt) return;

            belt.style.overflowX = "auto";
            belt.style.scrollBehavior = "smooth";

            if(action === "home") belt.scrollTo({ left: 0, behavior: "smooth" });
            if(action === "end") belt.scrollTo({ left: belt.scrollWidth, behavior: "smooth" });
          }
        });
      });
    }

    function renderBeltLane(content, lane, allItems){
      // Show first BELT_VISIBLE, rest in drawer
      const visible = allItems.slice(0, BELT_VISIBLE);
      const hidden = allItems.slice(BELT_VISIBLE);

      const beltWrap = document.createElement("div");
      beltWrap.className = "beltWrap";

      const hint = document.createElement("div");
      hint.className = "beltHint";
      hint.textContent = "Compact belt";

      const belt = document.createElement("div");
      belt.className = "belt";
      belt.dataset.beltLane = lane.key;

      visible.forEach(it => belt.appendChild(buildTile(it, { showStageChip:true })));

      if(hidden.length){
        const more = document.createElement("div");
        more.className = "moreChip show";
        more.style.position = "static";
        more.style.transform = "none";
        more.textContent = `+${hidden.length} more`;
        more.addEventListener("click", () => {
          openDrawer({
            laneKey: lane.key,
            title: `${lane.label} · Hidden Processes`,
            subtitle: `Showing ${visible.length} of ${allItems.length}. Select to open details.`,
            sections: [{
              title: "Overflow list",
              countText: `${hidden.length} items`,
              items: hidden
            }]
          });
        });
        belt.appendChild(more);
      }

      beltWrap.appendChild(hint);
      beltWrap.appendChild(belt);
      content.appendChild(beltWrap);
    }

    function renderGridStoryLane(content, lane, allItems){
      // Build per-stage buckets, but keep continuous ones in separate row (never consuming stage slots)
      const perStage = Array.from({length:7}, () => []);
      const continuous = [];

      for(const it of allItems){
        const span = getSpanFor(it.l0Id, it.l1Id);
        if(span){
          continuous.push({ ...it, span });
          continue;
        }
        const col = colForL1(it.l0Id, it.l1Node);
        const idx = Math.max(1, Math.min(7, col)) - 1;
        perStage[idx].push(it);
      }

      // fixed-height container
      const wrapper = document.createElement("div");
      wrapper.className = "gridLaneFixed";
      wrapper.style.gridColumn = "1 / -1";
      wrapper.style.display = "grid";
      wrapper.style.gridTemplateColumns = "repeat(7, minmax(170px, 1fr))";
      wrapper.style.gap = "10px";
      wrapper.style.padding = "2px 0 0 0";

      // Render stage columns with caps and overflow chips
      perStage.forEach((list, i) => {
        const col = document.createElement("div");
        col.className = "stageCol";
        col.dataset.stage = String(i+1);

        const shown = list.slice(0, STORY_MAX_PER_STAGE);
        const hidden = list.slice(STORY_MAX_PER_STAGE);

        shown.forEach(it => {
          const tile = buildTile(it, { showStageChip:false });
          tile.style.height = "44px";
          col.appendChild(tile);
        });

        // pad empty rows so columns align nicely
        for(let k=shown.length; k<STORY_MAX_PER_STAGE; k++){
          const spacer = document.createElement("div");
          spacer.style.height = "44px";
          spacer.style.borderRadius = "12px";
          spacer.style.border = "1px dashed rgba(16,24,40,0.10)";
          spacer.style.background = "rgba(255,255,255,0.55)";
          col.appendChild(spacer);
        }

        const chip = document.createElement("div");
        chip.className = "moreChip";
        chip.textContent = `+${hidden.length}`;
        if(hidden.length) chip.classList.add("show");

        chip.addEventListener("click", () => {
          openDrawer({
            laneKey: lane.key,
            title: `${lane.label} · Stage ${i+1} Overflow`,
            subtitle: `Stage: ${STAGES[i].name} · Select a process to open details.`,
            sections: [{
              title: `Stage ${i+1} — ${STAGES[i].name}`,
              countText: `${hidden.length} hidden`,
              items: hidden
            }]
          });
        });

        col.appendChild(chip);
        wrapper.appendChild(col);
      });

      content.appendChild(wrapper);

      // Render continuous row (if any) below fixed grid container (still compact)
      if(continuous.length){
        const contRow = document.createElement("div");
        contRow.className = "continuousRow";

        const lab = document.createElement("div");
        lab.className = "continuousLabel";
        lab.textContent = "Continuous";

        contRow.appendChild(lab);

        // show first 1 continuous tile to keep compact; rest to drawer
        const shownC = continuous.slice(0, 1);
        const hiddenC = continuous.slice(1);

        shownC.forEach(it => {
          const t = buildTile(it, { showStageChip:true });
          t.style.minWidth = "340px";
          contRow.appendChild(t);
        });

        if(hiddenC.length){
          const more = document.createElement("div");
          more.className = "moreChip show";
          more.style.position = "static";
          more.style.transform = "none";
          more.textContent = `+${hiddenC.length} more`;
          more.addEventListener("click", () => {
            openDrawer({
              laneKey: lane.key,
              title: `${lane.label} · Continuous Services`,
              subtitle: `Select a continuous process to open details.`,
              sections: [{
                title: "Continuous overflow",
                countText: `${hiddenC.length} hidden`,
                items: hiddenC
              }]
            });
          });
          contRow.appendChild(more);
        }

        content.appendChild(contRow);
      }
    }

    function renderFoundationCapsules(content, lane, allItems){
      // Group by L0 code; each group is a capsule showing 2 tiles + (+n)
      const groups = new Map();
      for(const it of allItems){
        if(!groups.has(it.l0Id)) groups.set(it.l0Id, []);
        groups.get(it.l0Id).push(it);
      }

      const row = document.createElement("div");
      row.className = "capsuleRow";

      // Keep stable ordering based on lane.l0Codes
      for(const code of lane.l0Codes){
        const list = groups.get(code) || [];
        if(!list.length) continue;

        const cap = document.createElement("div");
        cap.className = "capsule";

        const shown = list.slice(0, 2);
        const hidden = list.slice(2);

        cap.innerHTML = `
          <div class="capsuleHead">
            <div class="capsuleTitle">${esc(code)}</div>
            <div class="capsuleCount">${esc(list.length)} L1</div>
          </div>
          <div class="capsuleBody"></div>
        `;

        const bodyEl = cap.querySelector(".capsuleBody");
        shown.forEach(it => bodyEl.appendChild(buildTile(it, { showStageChip:true })));

        // ensure 2 slots
        for(let k=shown.length; k<2; k++){
          const spacer = document.createElement("div");
          spacer.style.height = "44px";
          spacer.style.borderRadius = "12px";
          spacer.style.border = "1px dashed rgba(16,24,40,0.10)";
          spacer.style.background = "rgba(255,255,255,0.55)";
          bodyEl.appendChild(spacer);
        }

        if(hidden.length){
          const more = document.createElement("div");
          more.className = "moreChip show";
          more.style.position = "static";
          more.style.transform = "none";
          more.style.marginTop = "6px";
          more.textContent = `+${hidden.length} more`;
          more.addEventListener("click", () => {
            openDrawer({
              laneKey: lane.key,
              title: `Foundation · ${code} Overflow`,
              subtitle: `Select a process to open details.`,
              sections: [{
                title: code,
                countText: `${hidden.length} hidden`,
                items: hidden
              }]
            });
          });
          cap.appendChild(more);
        }

        row.appendChild(cap);
      }

      // If too many capsules for width, they will compress; user can collapse lane or rely on drawer counts.
      content.appendChild(row);
    }

    /***********************
     * Deck
     ***********************/
    const deck = $("#deck");
    const deckHandle = $("#deckHandle");
    const deckHandleTitle = $("#deckHandleTitle");
    const deckHint = $("#deckHint");
    const deckBody = $("#deckBody");
    const mapWrap = $("#mapWrap");

    function setDeckOpen(open){
      if(open){
        deck.classList.add("open");
        mapWrap.classList.add("deckOpen");
        deckBody.style.display = "flex";
        deckHint.textContent = "▼ Collapse";
      }else{
        deck.classList.remove("open");
        mapWrap.classList.remove("deckOpen");
        deckBody.style.display = "none";
        deckHint.textContent = "▲ Expand";
      }
    }

    deckHandle.addEventListener("click", () => {
      const open = deck.classList.contains("open");
      setDeckOpen(!open);
    });

    function selectL1(l0Id, l1Node){
      const l0Node = L0MAP.get(l0Id);
      const l0Info = parseInfo(l0Node?.name);
      const l1Info = parseInfo(l1Node?.name);

      deckHandleTitle.textContent = `${l1Info.id} — ${l1Info.name}`;

      const owner = (l1Node?.owner || l0Node?.owner || "Unassigned");
      const desc = (l1Node?.description || "");

      const l2s = safeChildren(l1Node).map(l2=>{
        const i2 = parseInfo(l2.name);
        const l3s = safeChildren(l2).map(l3=>{
          const i3 = parseInfo(l3.name);
          return { id: i3.id, name: i3.name, node: l3 };
        });
        return { id: i2.id, name: i2.name, node: l2, l3s };
      });

      deckBody.innerHTML = `
        <div class="l1Meta">
          <div class="l1Heading">
            <p class="h1">${esc(l1Info.id)} · ${esc(l1Info.name)}</p>
            <p class="desc">${esc(desc || "No description available.")}</p>
          </div>
          <div class="metaPills">
            <span class="metaPill id">${esc(l0Info.id || l0Id)} · L0</span>
            <span class="metaPill owner">Owner: ${esc(owner)}</span>
          </div>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <div style="font-size:12px;font-weight:950;color:var(--ink);">L2 Sub-processes → L3 Activities</div>
          <div style="font-size:11px;font-weight:850;color:var(--muted);white-space:nowrap;">L3 is always visible</div>
        </div>

        <div class="l2Chain" id="l2Chain"></div>
      `;

      const chain = $("#l2Chain");
      if(!l2s.length){
        chain.innerHTML = `<div class="empty">No L2 sub-processes found for this L1.</div>`;
      }else{
        for(const l2 of l2s){
          const block = document.createElement("div");
          block.className = "l2Block";

          const l2Owner = (l2.node?.owner || l1Node?.owner || l0Node?.owner || "Unassigned");

          const l3Html = (l2.l3s.length)
            ? l2.l3s.map(x => `
                <div class="l3Item">
                  <div class="l3Top">
                    <span>${esc(x.id)}</span>
                    <span>${esc(l2Owner)}</span>
                  </div>
                  <p class="l3Name">${esc(x.name)}</p>
                </div>
              `).join("")
            : `<div class="empty">No L3 activities.</div>`;

          block.innerHTML = `
            <div class="l2Header">
              <div class="l2HeaderLeft">
                <div class="l2Id">${esc(l2.id)}</div>
                <p class="l2Name" title="${esc(l2.name)}">${esc(l2.name)}</p>
              </div>
              <div style="text-align:right;">
                <div class="metaPill" style="padding:5px 8px; font-size:10px; background:#FFF9E6; border-color: rgba(255,204,0,0.55); color:#7a5a00;">
                  L2 Owner: ${esc(l2Owner)}
                </div>
              </div>
            </div>
            <div class="l3List">${l3Html}</div>
          `;

          chain.appendChild(block);
        }
      }

      setDeckOpen(true);
    }

    /***********************
     * Load JSON
     ***********************/
    function showError(msg){
      const box = $("#errBox");
      box.style.display = "block";
      box.textContent = msg;
    }

    // Optional: simple search just scrolls to first matching visible tile; full search UI can be re-added later
    const searchInput = $("#searchInput");
    searchInput.addEventListener("keydown", (e) => {
      if(e.key !== "Enter") return;
      const q = searchInput.value.trim().toLowerCase();
      if(!q) return;
      const tiles = Array.from(document.querySelectorAll(".tile"));
      const hit = tiles.find(t => (t.dataset.l1 || "").toLowerCase().includes(q));
      if(hit){
        hit.scrollIntoView({ behavior:"smooth", block:"center" });
        hit.click();
      }
    });

    // Render header
    renderStageHeader();

    fetch("data.json")
      .then(r => {
        if(!r.ok) throw new Error("HTTP " + r.status);
        return r.json();
      })
      .then(data => {
        if(!data || !Array.isArray(data.children)){
          showError("data.json loaded but is missing expected 'children' array at root.");
          return;
        }
        ROOT = data;
        L0MAP = getL0Map(ROOT);
        renderMap();
      })
      .catch(err => {
        showError("Cannot load data.json. Run via a local server (not file://) and ensure data.json is next to this HTML. " + err);
        console.error(err);
      });
  </script>
</body>
</html>