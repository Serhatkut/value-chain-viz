<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DHL eCommerce · Enterprise Process Architecture · Process Chains</title>

  <style>
    :root{
      --dhl-red:#D40511;
      --dhl-yellow:#FFCC00;

      --ink:#111;
      --muted:#666;
      --bg:#f6f6f7;
      --card:#ffffff;
      --line:#e3e3e7;

      /* Level colors */
      --l0: var(--dhl-red);
      --l1: var(--dhl-yellow);
      --l2:#2b2f33;      /* dark grey */
      --l3:#eeeeef;      /* light grey */

      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --shadow-soft: 0 6px 18px rgba(0,0,0,.06);

      --chev-notch: 20px;
      --chev-tip: 28px;

      --maxw: 1480px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--ink);
      background:var(--bg);
    }

    /* Top bar */
    .topbar{
      position:sticky;
      top:0;
      z-index:50;
      background: linear-gradient(180deg, rgba(255,204,0,.95), rgba(255,204,0,.92));
      border-bottom:1px solid rgba(0,0,0,.10);
      backdrop-filter: blur(6px);
    }
    .topbar-inner{
      max-width: var(--maxw);
      margin:0 auto;
      padding: 14px 18px 10px;
    }
    .brand-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:flex-start;
      min-width: 260px;
    }
    .brand-mark{
      width:10px; height:34px;
      background: var(--dhl-red);
      border-radius:999px;
      margin-top:2px;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.06);
    }
    .brand h1{
      font-size: 18px;
      line-height:1.15;
      margin:0;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .brand .sub{
      font-size:12px;
      color:#3a2b00;
      opacity:.85;
      font-weight: 750;
      margin-top:2px;
    }

    .controls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      background: rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.10);
      border-radius:999px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:10px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .pill input{
      border:none;
      outline:none;
      background:transparent;
      font-weight:800;
      font-size:12px;
      width: 320px;
      max-width: 55vw;
    }
    .toggle{
      user-select:none;
      cursor:pointer;
      font-size:12px;
      font-weight:900;
      gap:8px;
    }
    .toggle input{ transform: translateY(1px); }

    .btn{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:9px 12px;
      font-weight:900;
      font-size:12px;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(0,0,0,.12);
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
    }
    .btn:hover{ filter: brightness(.98); }
    .btn-primary{
      background: var(--dhl-red);
      color:white;
      border-color: rgba(0,0,0,.15);
    }

    /* L0 Tabs */
    .tabs{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .tab{
      border:none;
      cursor:pointer;
      background: rgba(255,255,255,.75);
      border:1px solid rgba(0,0,0,.12);
      padding:9px 10px;
      border-radius:999px;
      font-weight:950;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 3px 12px rgba(0,0,0,.06);
      color:#111;
      max-width: 100%;
    }
    .tab .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--l0);
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.6);
      flex:0 0 auto;
    }
    .tab .small{
      font-size:11px;
      opacity:.75;
      font-weight:1000;
      white-space:nowrap;
    }
    .tab span:nth-child(2){
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 46vw;
    }
    .tab.active{
      background: rgba(212,5,17,.12);
      border-color: rgba(212,5,17,.35);
    }

    /* Main layout */
    .wrap{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 14px 18px 28px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* Process House accordion */
    .process-house{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    .process-house summary{
      cursor:pointer;
      list-style:none;
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.75));
    }
    .process-house summary::-webkit-details-marker{ display:none; }
    .summary-left{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:950;
    }
    .house-pill{
      font-size:12px;
      font-weight:1000;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(212,5,17,.12);
      border:1px solid rgba(212,5,17,.25);
      color: var(--dhl-red);
    }
    .hint{
      font-size:12px;
      font-weight:850;
      color: rgba(0,0,0,.55);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 60vw;
    }
    .house-grid{
      padding: 12px 12px 14px;
      display:grid;
      grid-template-columns: repeat(4, minmax(220px, 1fr));
      gap: 12px;
    }
    @media (max-width: 1100px){
      .house-grid{ grid-template-columns: repeat(2, minmax(220px, 1fr)); }
    }
    @media (max-width: 640px){
      .house-grid{ grid-template-columns: 1fr; }
    }
    .house-col{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px;
      background: rgba(255,255,255,.9);
    }
    .house-col h3{
      margin:0 0 10px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      font-weight: 1000;
      color: rgba(0,0,0,.75);
    }
    .cat-tag{
      font-size:11px;
      font-weight:1000;
      color: rgba(0,0,0,.65);
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,204,0,.18);
    }
    .house-card{
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 10px 10px 9px;
      background: #fff;
      box-shadow: 0 3px 12px rgba(0,0,0,.06);
      cursor:pointer;
      transition: transform .08s ease, box-shadow .08s ease;
    }
    .house-card:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
    }
    .house-code{
      font-weight: 1000;
      font-size: 12px;
      color: var(--dhl-red);
      letter-spacing:.2px;
    }
    .house-name{
      margin-top: 2px;
      font-weight: 1000;
      font-size: 13px;
    }
    .house-desc{
      margin-top: 5px;
      font-size: 11px;
      font-weight: 800;
      color: rgba(0,0,0,.60);
      line-height:1.25;
    }

    /* Sections */
    .section{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    .section-head{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.75));
      border-bottom: 1px solid var(--line);
      flex-wrap:wrap;
    }
    .section-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:1000;
      font-size:12px;
    }
    .badge{
      font-size:11px;
      font-weight:1000;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
    }
    .badge.l1{ background: rgba(255,204,0,.25); border-color: rgba(255,204,0,.45); }
    .badge.l2{ background: rgba(43,47,51,.10); border-color: rgba(43,47,51,.22); }
    .badge.l3{ background: rgba(238,238,239,.80); border-color: rgba(0,0,0,.12); }

    /* Chevron chain: full width + wrap rows */
    .chain{
      padding: 12px;
      display:grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      align-items:stretch;
    }
    @media (max-width: 520px){
      .chain{ grid-template-columns: 1fr; }
    }

    .chev{
      position:relative;
      cursor:pointer;
      border-radius: 14px;
      box-shadow: 0 8px 18px rgba(0,0,0,.08);
      border:1px solid rgba(0,0,0,.14);
      padding: 12px 14px 12px 14px;
      min-height: 78px;
      display:flex;
      flex-direction:column;
      justify-content:center;

      /* Chevron shape via clip-path */
      clip-path: polygon(
        0% 0%,
        calc(100% - var(--chev-tip)) 0%,
        100% 50%,
        calc(100% - var(--chev-tip)) 100%,
        0% 100%,
        var(--chev-notch) 50%
      );
    }
    .chev.l1{ background: var(--l1); }
    .chev.l2{ background: var(--l2); color:#fff; border-color: rgba(0,0,0,.35); }
    .chev.l1 .meta{ color: rgba(0,0,0,.82); }
    .chev.l2 .meta{ color: rgba(255,255,255,.82); }

    .chev.active{
      outline: 3px solid rgba(212,5,17,.35);
      outline-offset: 2px;
    }

    .chev .topline{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .chev .code{
      font-weight:1000;
      font-size:12px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chev .order{
      font-weight:1000;
      font-size:11px;
      opacity:.75;
      white-space:nowrap;
    }
    .chev .name{
      margin-top: 3px;
      font-weight:1000;
      font-size: 13px;
      line-height:1.12;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      min-height: 28px;
    }
    .chev .meta{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 800;
      line-height: 1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    /* L3 + Details (next to each other) */
    .l3-grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 980px){
      .l3-grid{ grid-template-columns: 1fr; }
    }

    .waterfall{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .l3-card{
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      padding: 10px 12px;
      background: #fff;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      cursor:pointer;
    }
    .l3-card.active{
      outline: 3px solid rgba(212,5,17,.22);
      outline-offset: 2px;
    }
    .l3-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .l3-code{
      font-weight:1000;
      font-size:12px;
      color: var(--dhl-red);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70%;
    }
    .l3-owner{
      font-weight:1000;
      font-size:11px;
      color: rgba(0,0,0,.62);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 45%;
      text-align:right;
    }
    .l3-name{
      margin-top: 4px;
      font-weight:1000;
      font-size: 13px;
      line-height:1.15;
    }
    .l3-desc{
      margin-top: 6px;
      font-size: 11px;
      font-weight: 800;
      color: rgba(0,0,0,.60);
      line-height:1.25;
    }
    .l4{
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px dashed rgba(0,0,0,.15);
      color: rgba(0,0,0,.72);
      font-size: 11px;
      font-weight: 850;
    }
    .l4 ul{
      margin: 6px 0 0 16px;
      padding:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .details-card{
      border:1px solid rgba(0,0,0,.12);
      border-radius: 14px;
      background:#fff;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      overflow:hidden;
      position: sticky;
      top: 110px; /* below header */
    }
    @media (max-width: 980px){
      .details-card{ position:relative; top:auto; }
    }

    .details-head{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.75));
    }
    .details-head .title{
      margin:0;
      font-weight:1000;
      font-size:12px;
    }
    .breadcrumb{
      margin-top: 3px;
      font-size: 11px;
      font-weight: 850;
      color: rgba(0,0,0,.55);
      max-width: 60ch;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .details-body{
      padding: 10px 12px 12px;
    }
    .descbox{
      margin-top: 8px;
      border-radius: 12px;
      padding: 9px 10px;
      background: rgba(255,204,0,.18);
      border: 1px solid rgba(255,204,0,.35);
      font-size: 11px;
      font-weight: 850;
      line-height:1.25;
    }
    .kv{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 8px 10px;
      font-size: 11px;
      line-height:1.25;
    }
    .kv .k{
      font-weight:1000;
      color: rgba(0,0,0,.62);
    }
    .kv .v{
      font-weight: 900;
      color: rgba(0,0,0,.85);
      word-break: break-word;
    }

    .empty{
      padding: 10px;
      border-radius: 12px;
      border: 1px dashed rgba(0,0,0,.18);
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
      background: #fff;
    }
    .footer-note{
      margin-top: 12px;
      color: rgba(0,0,0,.55);
      font-size: 11px;
      font-weight: 800;
      line-height:1.3;
    }
    .error{
      background: rgba(212,5,17,.10);
      border: 1px solid rgba(212,5,17,.22);
      color: #7d0008;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 950;
      font-size: 12px;
      margin-top: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand-row">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true"></div>
          <div>
            <h1>DHL eCommerce</h1>
            <div class="sub">Enterprise Business Architecture · Process Chains</div>
          </div>
        </div>

        <div class="controls">
          <div class="pill" title="Search filters current L0/L1/L2/L3 (code, name, description, owner, trigger, outcome, notes)">
            <span style="font-weight:1000;font-size:12px;">Search</span>
            <input id="search" type="text" placeholder="Filter (code/name/description/owner/trigger/outcome)"/>
          </div>

          <label class="toggle pill" title="When enabled, auto-select first available item when changing levels">
            <input id="autoOpen" type="checkbox" checked />
            Auto-open
          </label>

          <button id="reset" class="btn">Reset</button>
          <button id="openHouse" class="btn btn-primary">Process House</button>
        </div>
      </div>

      <div id="tabs" class="tabs" aria-label="L0 tabs"></div>
    </div>
  </header>

  <main class="wrap">
    <!-- Process House Accordion -->
    <details id="house" class="process-house" open>
      <summary>
        <div class="summary-left">
          <span class="house-pill">L0 View</span>
          <span>Process House</span>
        </div>
        <span class="hint">Click a card to select an L0 (collapsible)</span>
      </summary>
      <div id="houseGrid" class="house-grid"></div>
    </details>

    <!-- L1 -->
    <section class="section">
      <div class="section-head">
        <div class="section-title">
          <span class="badge l1">L1</span>
          <span>L1 Chain</span>
          <span id="l1Count" class="badge l1">0</span>
        </div>
        <div id="l1Hint" class="hint">Select an L0 tab to show L1.</div>
      </div>
      <div id="l1Chain" class="chain"></div>
    </section>

    <!-- L2 -->
    <section class="section">
      <div class="section-head">
        <div class="section-title">
          <span class="badge l2">L2</span>
          <span>L2 Sub-Chain</span>
          <span id="l2Count" class="badge l2">0</span>
        </div>
        <div id="l2Hint" class="hint">Select an L1 to show L2.</div>
      </div>
      <div id="l2Chain" class="chain"></div>
    </section>

    <!-- L3 + Details -->
    <section class="section">
      <div class="section-head">
        <div class="section-title">
          <span class="badge l3">L3</span>
          <span>L3 Activities</span>
          <span id="l3Count" class="badge l3">0</span>
        </div>
        <div id="l3Hint" class="hint">Select an L2 to show L3 waterfall.</div>
      </div>

      <div class="l3-grid">
        <div>
          <div id="l3List" class="waterfall"></div>
          <div class="footer-note">
            L3 shows all children of the selected L2. If an L3 has sub-activities (L4), they appear as bullets.
            Search includes descendant matches (so you won’t “lose” items because the match is in L4).
          </div>
        </div>

        <div>
          <div class="details-card">
            <div class="details-head">
              <div>
                <p class="title">Details</p>
                <div id="breadcrumb" class="breadcrumb">—</div>
              </div>
              <button id="collapseDetails" class="btn" title="Collapse/expand details">Collapse</button>
            </div>
            <div id="detailsBody" class="details-body">
              <div class="empty">Select a process element (L1/L2/L3) to see details.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div id="err" style="display:none;" class="error"></div>
  </main>

  <script>
    // ----------------------------
    // State
    // ----------------------------
    const state = {
      data: null,
      l0List: [],
      selected: { l0:null, l1:null, l2:null, l3:null },
      search: "",
      autoOpen: true,
      detailsCollapsed: false,
    };

    // ----------------------------
    // DOM
    // ----------------------------
    const $ = (id) => document.getElementById(id);
    const tabsEl = $("tabs");
    const houseEl = $("house");
    const houseGridEl = $("houseGrid");

    const l1ChainEl = $("l1Chain");
    const l2ChainEl = $("l2Chain");
    const l3ListEl  = $("l3List");

    const l1CountEl = $("l1Count");
    const l2CountEl = $("l2Count");
    const l3CountEl = $("l3Count");

    const l1HintEl = $("l1Hint");
    const l2HintEl = $("l2Hint");
    const l3HintEl = $("l3Hint");

    const breadcrumbEl = $("breadcrumb");
    const detailsBodyEl = $("detailsBody");
    const collapseDetailsBtn = $("collapseDetails");
    const errEl = $("err");

    // ----------------------------
    // Helpers
    // ----------------------------
    function safeText(s){ return (s ?? "").toString(); }
    function escapeHtml(s){
      const str = safeText(s);
      return str.replace(/[&<>"']/g, (ch) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[ch]));
    }
    function normalize(s){ return safeText(s).trim().toLowerCase(); }

    function splitCodeAndTitle(name){
      const t = safeText(name);
      const i = t.indexOf(":");
      if(i === -1) return { code:"", title:t };
      return { code: t.slice(0,i).trim(), title: t.slice(i+1).trim() };
    }

    // More stable ordering than simple string compare:
    // S2E_02_10 sorts after S2E_02_02
    function sortById(a,b){
      const A = safeText(a?.id || a?.name || "");
      const B = safeText(b?.id || b?.name || "");
      const pa = A.split("_").map(x => (isFinite(+x) ? +x : x));
      const pb = B.split("_").map(x => (isFinite(+x) ? +x : x));
      const n = Math.max(pa.length, pb.length);
      for(let i=0;i<n;i++){
        const xa = pa[i], xb = pb[i];
        if(xa === undefined) return -1;
        if(xb === undefined) return  1;
        if(typeof xa === "number" && typeof xb === "number"){
          if(xa !== xb) return xa - xb;
        } else {
          const sa = safeText(xa), sb = safeText(xb);
          if(sa !== sb) return sa.localeCompare(sb);
        }
      }
      return 0;
    }

    // Fallback L0 category mapping if JSON doesn't provide "category"
    function inferL0Category(l0){
      const id = safeText(l0?.id).toUpperCase();
      if(l0?.category) return l0.category;

      // Manage the Business
      if(["S2E","GRC","EA_PM"].includes(id)) return "Manage the Business";

      // Run the Business (core operational chain)
      if(["L2C","O2D","D2O","P2R"].includes(id)) return "Run the Business";

      // Enabling functions (also part of run, but keep distinct if you want later)
      if(["S2P","H2R","R2R"].includes(id)) return "Enabling Functions";

      // Change the Business
      if(["I2P","TRF"].includes(id)) return "Change the Business";

      // Foundation
      if(["DA","ITF"].includes(id)) return "Foundation";

      return "Other";
    }

    function deepMatch(node, q){
      if(!q) return true;
      if(!node) return false;

      const hay = [
        node.id, node.name, node.description, node.owner,
        node.trigger, node.outcome, node.notes, node.category
      ].map(normalize).join(" | ");

      if(hay.includes(q)) return true;

      // If query matches any descendant, keep parent so the chain doesn't look "incomplete"
      const kids = Array.isArray(node.children) ? node.children : [];
      for(const c of kids){
        if(deepMatch(c, q)) return true;
      }
      return false;
    }

    function filteredChildren(node){
      const kids = Array.isArray(node?.children) ? node.children : [];
      const q = normalize(state.search);
      const out = q ? kids.filter(k => deepMatch(k, q)) : kids.slice();
      out.sort(sortById);
      return out;
    }

    function getBreadcrumb(){
      const parts = [];
      if(state.selected.l0) parts.push(splitCodeAndTitle(state.selected.l0.name).title || state.selected.l0.id);
      if(state.selected.l1) parts.push(splitCodeAndTitle(state.selected.l1.name).title || state.selected.l1.id);
      if(state.selected.l2) parts.push(splitCodeAndTitle(state.selected.l2.name).title || state.selected.l2.id);
      if(state.selected.l3) parts.push(splitCodeAndTitle(state.selected.l3.name).title || state.selected.l3.id);
      return parts.length ? parts.join(" > ") : "—";
    }

    // ----------------------------
    // Render: Process House
    // ----------------------------
    function renderProcessHouse(){
      const groups = {};
      for(const raw of state.l0List){
        const l0 = { ...raw, category: inferL0Category(raw) };
        const cat = l0.category || "Other";
        if(!groups[cat]) groups[cat] = [];
        groups[cat].push(l0);
      }

      const preferred = ["Manage the Business","Run the Business","Enabling Functions","Change the Business","Foundation","Other"];
      const cats = [
        ...preferred.filter(c => groups[c] && groups[c].length),
        ...Object.keys(groups).filter(c => !preferred.includes(c))
      ];

      houseGridEl.innerHTML = cats.map(cat => {
        const cards = (groups[cat]||[])
          .sort(sortById)
          .map(l0 => {
            const { code, title } = splitCodeAndTitle(l0.name);
            return `
              <div class="house-card" data-l0="${escapeHtml(l0.id)}" role="button" tabindex="0">
                <div class="house-code">${escapeHtml(code || l0.id)}</div>
                <div class="house-name">${escapeHtml(title || l0.name)}</div>
                <div class="house-desc">${escapeHtml(l0.description || "")}</div>
              </div>
            `;
          }).join("");

        return `
          <div class="house-col">
            <h3>
              <span>${escapeHtml(cat)}</span>
              <span class="cat-tag">${escapeHtml((groups[cat]||[]).length)} L0</span>
            </h3>
            <div style="display:grid;gap:10px;">${cards}</div>
          </div>
        `;
      }).join("");

      houseGridEl.querySelectorAll(".house-card").forEach(card => {
        card.addEventListener("click", () => {
          selectL0(card.getAttribute("data-l0"));
          houseEl.open = false;
        });
        card.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            card.click();
          }
        });
      });
    }

    // ----------------------------
    // Render: Tabs (L0)
    // ----------------------------
    function renderTabs(){
      tabsEl.innerHTML = state.l0List.map(l0 => {
        const active = state.selected.l0?.id === l0.id ? "active" : "";
        const { code, title } = splitCodeAndTitle(l0.name);
        return `
          <button class="tab ${active}" data-l0="${escapeHtml(l0.id)}" title="${escapeHtml(l0.name)}">
            <span class="dot" aria-hidden="true"></span>
            <span>${escapeHtml(title || l0.name)}</span>
            <span class="small">${escapeHtml(code || l0.id)}</span>
          </button>
        `;
      }).join("");

      tabsEl.querySelectorAll(".tab").forEach(btn => {
        btn.addEventListener("click", () => selectL0(btn.getAttribute("data-l0")));
      });
    }

    // ----------------------------
    // Render: L1/L2 chevrons
    // ----------------------------
    function renderChain(container, items, level){
      container.innerHTML = "";
      if(!items || items.length === 0) return;

      const selectedId = state.selected[level]?.id;

      for(let i=0;i<items.length;i++){
        const n = items[i];
        const active = selectedId === n.id ? "active" : "";
        const { code, title } = splitCodeAndTitle(n.name || "");
        const meta = n.description || n.owner || "";

        const el = document.createElement("div");
        el.className = `chev ${level} ${active}`;
        el.setAttribute("role","button");
        el.setAttribute("tabindex","0");
        el.dataset.id = n.id;

        el.innerHTML = `
          <div class="topline">
            <div class="code">${escapeHtml(code || n.id || "")}</div>
            <div class="order">#${i+1}</div>
          </div>
          <div class="name">${escapeHtml(title || n.name || "")}</div>
          <div class="meta">${escapeHtml(meta)}</div>
        `;

        el.addEventListener("click", () => {
          if(level === "l1") selectL1(n.id);
          if(level === "l2") selectL2(n.id);
          renderDetails(n);
        });
        el.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            el.click();
          }
        });

        container.appendChild(el);
      }
    }

    // ----------------------------
    // Render: L3 waterfall
    // ----------------------------
    function renderL3(items){
      l3ListEl.innerHTML = "";
      if(!items || items.length === 0){
        l3ListEl.innerHTML = `<div class="empty">No L3 items to display.</div>`;
        return;
      }

      const selectedId = state.selected.l3?.id;

      for(const l3 of items){
        const { code, title } = splitCodeAndTitle(l3.name || "");
        const owner = safeText(l3.owner);
        const desc = safeText(l3.description);

        const card = document.createElement("div");
        card.className = `l3-card ${selectedId === l3.id ? "active" : ""}`;
        card.dataset.id = l3.id;

        const l4Kids = Array.isArray(l3.children) ? l3.children : [];
        const l4Html = l4Kids.length ? `
          <div class="l4">
            Sub-activities (${l4Kids.length})
            <ul>
              ${l4Kids.sort(sortById).map(x => {
                const s = splitCodeAndTitle(x.name || "");
                return `<li><b>${escapeHtml(s.code || x.id || "")}</b> — ${escapeHtml(s.title || x.name || "")}</li>`;
              }).join("")}
            </ul>
          </div>
        ` : "";

        card.innerHTML = `
          <div class="l3-head">
            <div class="l3-code">${escapeHtml(code || l3.id || "")}</div>
            <div class="l3-owner">${escapeHtml(owner || "")}</div>
          </div>
          <div class="l3-name">${escapeHtml(title || l3.name || "")}</div>
          ${desc ? `<div class="l3-desc">${escapeHtml(desc)}</div>` : ``}
          ${l4Html}
        `;

        card.addEventListener("click", () => {
          state.selected.l3 = l3;
          breadcrumbEl.textContent = getBreadcrumb();
          renderDetails(l3);
          // highlight
          renderL3(items);
        });

        l3ListEl.appendChild(card);
      }
    }

    // ----------------------------
    // Details panel (next to L3)
    // ----------------------------
    function renderDetails(node){
      breadcrumbEl.textContent = getBreadcrumb();

      if(state.detailsCollapsed){
        detailsBodyEl.innerHTML = `<div class="empty">Details collapsed. Click “Expand” to view.</div>`;
        return;
      }
      if(!node){
        detailsBodyEl.innerHTML = `<div class="empty">Select a process element (L1/L2/L3) to see details.</div>`;
        return;
      }

      const { code, title } = splitCodeAndTitle(node.name || "");
      const desc = safeText(node.description);
      const rows = [
        ["ID", safeText(node.id)],
        ["Code", code || "—"],
        ["Name", title || safeText(node.name)],
        ["Owner", safeText(node.owner) || "—"],
      ];
      if(node.category) rows.push(["Category", safeText(node.category)]);
      if(node.trigger)  rows.push(["Trigger", safeText(node.trigger)]);
      if(node.outcome)  rows.push(["Outcome", safeText(node.outcome)]);
      if(node.notes)    rows.push(["Notes", safeText(node.notes)]);

      const kv = rows.map(([k,v]) => `
        <div class="k">${escapeHtml(k)}</div>
        <div class="v">${escapeHtml(v)}</div>
      `).join("");

      detailsBodyEl.innerHTML = `
        <div style="font-weight:1000;font-size:12px;color:var(--dhl-red);">${escapeHtml(code || node.id || "")}</div>
        <div style="font-weight:1000;font-size:13px;margin-top:3px;">${escapeHtml(title || node.name || "")}</div>
        ${desc ? `<div class="descbox">${escapeHtml(desc)}</div>` : ``}
        <div class="kv">${kv}</div>
      `;
    }

    // ----------------------------
    // Selection handlers
    // ----------------------------
    function selectL0(l0Id){
      const l0 = state.l0List.find(x => x.id === l0Id);
      state.selected.l0 = l0 || null;
      state.selected.l1 = null;
      state.selected.l2 = null;
      state.selected.l3 = null;

      renderTabs();
      renderL1();
      renderL2();
      renderL3([]);
      l3CountEl.textContent = "0";
      l3HintEl.textContent = "Select an L2 to show L3 waterfall.";
      renderDetails(l0);
      breadcrumbEl.textContent = getBreadcrumb();

      if(state.autoOpen && l0){
        const l1s = filteredChildren(l0);
        if(l1s.length) selectL1(l1s[0].id);
      }
    }

    function selectL1(l1Id){
      const l0 = state.selected.l0;
      if(!l0) return;
      const l1 = (l0.children || []).find(x => x.id === l1Id);
      state.selected.l1 = l1 || null;
      state.selected.l2 = null;
      state.selected.l3 = null;

      renderL1();
      renderL2();
      renderL3([]);
      l3CountEl.textContent = "0";
      l3HintEl.textContent = "Select an L2 to show L3 waterfall.";
      renderDetails(l1);
      breadcrumbEl.textContent = getBreadcrumb();

      if(state.autoOpen && l1){
        const l2s = filteredChildren(l1);
        if(l2s.length) selectL2(l2s[0].id);
      }
    }

    function selectL2(l2Id){
      const l1 = state.selected.l1;
      if(!l1) return;
      const l2 = (l1.children || []).find(x => x.id === l2Id);
      state.selected.l2 = l2 || null;
      state.selected.l3 = null;

      renderL2();

      const l3s = l2 ? filteredChildren(l2) : [];
      l3CountEl.textContent = String(l3s.length);
      renderL3(l3s);

      l3HintEl.textContent = l2 ? `Selected L2: ${l2.name}` : "Select an L2 to show L3 waterfall.";
      renderDetails(l2);
      breadcrumbEl.textContent = getBreadcrumb();

      if(state.autoOpen && l3s.length){
        state.selected.l3 = l3s[0];
        breadcrumbEl.textContent = getBreadcrumb();
        renderDetails(l3s[0]);
        renderL3(l3s);
      }
    }

    function renderL1(){
      const l0 = state.selected.l0;
      const l1s = l0 ? filteredChildren(l0) : [];
      l1CountEl.textContent = String(l1s.length);
      renderChain(l1ChainEl, l1s, "l1");
      l1HintEl.textContent = l0 ? `Selected L0: ${l0.name}` : "Select an L0 tab to show L1.";
    }

    function renderL2(){
      const l1 = state.selected.l1;
      const l2s = l1 ? filteredChildren(l1) : [];
      l2CountEl.textContent = String(l2s.length);
      renderChain(l2ChainEl, l2s, "l2");
      l2HintEl.textContent = l1 ? `Selected L1: ${l1.name}` : "Select an L1 to show L2.";
    }

    // ----------------------------
    // Events
    // ----------------------------
    $("search").addEventListener("input", (e) => {
      state.search = normalize(e.target.value);
      renderTabs();
      renderProcessHouse();
      renderL1();
      renderL2();

      if(state.selected.l2){
        const l3s = filteredChildren(state.selected.l2);
        l3CountEl.textContent = String(l3s.length);
        renderL3(l3s);
      } else {
        l3CountEl.textContent = "0";
        renderL3([]);
      }
      breadcrumbEl.textContent = getBreadcrumb();
    });

    $("autoOpen").addEventListener("change", (e) => {
      state.autoOpen = !!e.target.checked;
    });

    $("reset").addEventListener("click", () => {
      $("search").value = "";
      state.search = "";
      state.detailsCollapsed = false;
      collapseDetailsBtn.textContent = "Collapse";
      if(state.l0List.length){
        selectL0(state.l0List[0].id);
      }
      renderProcessHouse();
    });

    $("openHouse").addEventListener("click", () => {
      houseEl.open = true;
      houseEl.scrollIntoView({ behavior:"smooth", block:"start" });
    });

    collapseDetailsBtn.addEventListener("click", () => {
      state.detailsCollapsed = !state.detailsCollapsed;
      collapseDetailsBtn.textContent = state.detailsCollapsed ? "Expand" : "Collapse";
      const node = state.selected.l3 || state.selected.l2 || state.selected.l1 || state.selected.l0;
      renderDetails(node);
    });

    // ----------------------------
    // Data load (defensive)
    // ----------------------------
    function unwrapL0List(json){
      // Accept: {children:[...]}, {data:{children:[...]}}, or [...] (array root)
      if(Array.isArray(json)) return json;
      if(json && Array.isArray(json.children)) return json.children;
      if(json && json.data && Array.isArray(json.data.children)) return json.data.children;
      if(json && json.root && Array.isArray(json.root.children)) return json.root.children;
      return [];
    }

    async function fetchFirst(paths){
      let lastErr = null;
      for(const p of paths){
        try{
          const res = await fetch(`${p}?v=${Date.now()}`, { cache:"no-store" });
          if(!res.ok) throw new Error(`${p} -> HTTP ${res.status}`);
          const json = await res.json();
          return { json, path: p };
        } catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("Failed to load JSON");
    }

    async function init(){
      try{
        const candidates = [
          "data.json",
          "./data.json",
          "./assets/data.json",
          "./data/data.json"
        ];

        const { json, path } = await fetchFirst(candidates);

        state.data = json;
        state.l0List = unwrapL0List(json);

        // normalize categories (fallback inference)
        state.l0List = state.l0List.map(x => ({ ...x, category: inferL0Category(x) }));

        if(!state.l0List.length){
          throw new Error(
            "JSON loaded but no L0 list found. Expected one of: " +
            "{children:[...]}, {data:{children:[...]}}, {root:{children:[...]}}, or [...] (array root)."
          );
        }

        renderTabs();
        renderProcessHouse();
        selectL0(state.l0List[0].id);

        errEl.style.display = "block";
        errEl.textContent =
          `Loaded: ${path}\n` +
          `L0 count: ${state.l0List.length}\n` +
          `Tip: if you still see 0, open DevTools → Console to see fetch errors.`;
      } catch (e){
        errEl.style.display = "block";
        errEl.textContent =
          `Error loading process data.\n` +
          `${e?.message || e}\n\n` +
          `Checks:\n` +
          `• Ensure data.json is in the repo root (same folder as index.html)\n` +
          `• Ensure it is valid JSON (no trailing commas)\n` +
          `• Ensure GitHub Pages is serving the latest commit (cache can lie)\n`;
        console.error(e);
      }
    }

    init();
  </script>
</body>
</html>
